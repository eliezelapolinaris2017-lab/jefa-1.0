<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Salon Pro — Flujo de Caja (externo)</title>
<meta name="theme-color" content="#0f0f12">
<style>
:root{
  --bg:#0f0f12; --fg:#ffffff; --muted:#a7a7b1; --primary:#6ee7b7; --accent:#93c5fd;
  --card:#171821; --card2:#1e202b; --outline:#2a2d40; --radius:16px; --shadow:0 10px 28px rgba(0,0,0,.35);
  --font:ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,"Helvetica Neue",Arial;
}
*{box-sizing:border-box}
body{margin:0; background:#0f0f12; color:var(--fg); font-family:var(--font)}
.container{max-width:1160px; margin:1.2rem auto; padding:0 1rem 3rem}
.card{background:linear-gradient(180deg,var(--card),var(--card2)); border:1px solid var(--outline); border-radius:var(--radius); box-shadow:var(--shadow); padding:1rem}
.row{display:grid; gap:1rem}
.row.cols-2{grid-template-columns:1fr 1fr}
.row.cols-3{grid-template-columns:repeat(3,1fr)}
.row.cols-4{grid-template-columns:repeat(4,1fr)}
@media(max-width:980px){.row.cols-2,.row.cols-3,.row.cols-4{grid-template-columns:1fr}}
h1,h2,h3{margin:.2rem 0}
label{display:block; font-size:.9rem; color:var(--muted); margin:.12rem 0 .35rem}
.input, select{width:100%; padding:.8rem .9rem; background:#11131a; color:#fff; border:1px solid var(--outline); border-radius:12px; outline:none}
button{cursor:pointer; border:0; background:#24263a; color:#fff; border-radius:12px; padding:.75rem 1rem; box-shadow:var(--shadow)}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--accent))}
.btn-ghost{background:transparent; border:1px solid var(--outline)}
.table{width:100%; border-collapse:separate; border-spacing:0 10px}
.table th,.table td{padding:.7rem .9rem; text-align:left}
.tr{background:linear-gradient(180deg,#141726,#0f1220); border:1px solid var(--outline); border-radius:12px}
.tr td:first-child,.tr th:first-child{border-top-left-radius:12px; border-bottom-left-radius:12px}
.tr td:last-child,.tr th:last-child{border-top-right-radius:12px; border-bottom-right-radius:12px}
.kpis{display:grid; grid-template-columns:repeat(6,1fr); gap:1rem}
.kpi{padding:1rem; border-radius:16px; background:#10121a; border:1px solid var(--outline)}
.kpi .label{color:#b5bad6; font-size:.85rem}
.kpi .value{font-size:1.25rem; font-weight:800}
.badge{display:inline-block; padding:.25rem .6rem; border:1px solid var(--outline); border-radius:999px; font-size:.78rem; color:#c7d2fe}
hr{border:0; height:1px; background:linear-gradient(90deg,transparent,#2a3458,transparent); margin:1rem 0}
.actions{display:flex; gap:.5rem; flex-wrap:wrap}
@media print{.no-print{display:none !important} body{background:#fff; color:#000}}
</style>
</head>
<body>
  <main class="container">
    <div class="row">
      <div class="card">
        <div style="display:flex; align-items:center; gap:.8rem; flex-wrap:wrap">
          <h1 style="margin:0">Flujo de Caja — Salon Pro</h1>
          <span class="badge">Archivo externo (no altera tu app)</span>
          <div style="margin-left:auto" class="no-print actions">
            <button id="btnHoy" class="btn-ghost">Hoy</button>
            <button id="btnMes" class="btn-ghost">Mes</button>
            <button id="btnRango" class="btn-ghost">Rango</button>
            <button id="btnImprimir" class="btn-ghost">Imprimir</button>
            <button id="btnCSV" class="btn-ghost">Exportar CSV</button>
          </div>
        </div>
        <p style="margin:.2rem 0;color:#a9b1d6">Lee ventas de <code>sp_facturas</code> y guarda gastos en <code>sp_gastos</code>. Comparte <b>mismo dominio</b> para acceder al <i>localStorage</i>.</p>
      </div>
    </div>

    <!-- Filtros -->
    <div class="row" style="margin-top:1rem">
      <div class="card">
        <div class="row cols-4">
          <div><label>Desde</label><input id="f_desde" type="date" class="input"></div>
          <div><label>Hasta</label><input id="f_hasta" type="date" class="input"></div>
          <div>
            <label>Empleado/Técnica</label>
            <select id="f_emp" class="input"></select>
          </div>
          <div>
            <label>Incluir propinas en caja</label>
            <select id="f_propinas" class="input">
              <option value="0">No (solo ventas)</option>
              <option value="1">Sí (sumar propinas)</option>
            </select>
          </div>
        </div>
        <div class="row cols-4" style="margin-top:.6rem">
          <div>
            <label>Saldo inicial de caja</label>
            <input id="f_saldo" type="number" step=".01" class="input" placeholder="0.00">
          </div>
          <div class="actions" style="align-items:end">
            <button id="btnAplicar" class="btn-primary">Aplicar</button>
            <button id="btnReset" class="btn-ghost">Reset</button>
          </div>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row" style="margin-top:1rem">
      <div class="kpis">
        <div class="kpi"><div class="label">Ingresos</div><div class="value" id="kpi_ingresos">$0</div></div>
        <div class="kpi"><div class="label">Propinas (opc.)</div><div class="value" id="kpi_propinas">$0</div></div>
        <div class="kpi"><div class="label">Gastos</div><div class="value" id="kpi_gastos">$0</div></div>
        <div class="kpi"><div class="label">Caja Inicial</div><div class="value" id="kpi_inicial">$0</div></div>
        <div class="kpi"><div class="label">Flujo Neto</div><div class="value" id="kpi_neto">$0</div></div>
        <div class="kpi"><div class="label">Caja Final</div><div class="value" id="kpi_final">$0</div></div>
      </div>
    </div>

    <!-- Gráfico -->
    <div class="row" style="margin-top:1rem">
      <div class="card">
        <div style="display:flex; align-items:center">
          <b>Flujo diario (ingresos - gastos)</b>
          <span style="margin-left:auto; color:#a9b2dc; font-size:.9rem">Canvas sin librerías</span>
        </div>
        <canvas id="chart" height="190" style="width:100%"></canvas>
      </div>
    </div>

    <!-- Caja por método -->
    <div class="row" style="margin-top:1rem">
      <div class="card">
        <b>Caja por método de pago</b>
        <table class="table">
          <thead>
            <tr class="tr"><th>Método</th><th>Monto</th><th>% Ingresos</th></tr>
          </thead>
          <tbody id="tbMetodos"></tbody>
        </table>
      </div>
    </div>

    <!-- Detalle ventas/gastos -->
    <div class="row cols-2" style="margin-top:1rem">
      <div class="card">
        <b>Ventas del período</b>
        <table class="table">
          <thead><tr class="tr"><th>#</th><th>Fecha</th><th>Técnica</th><th>Método</th><th>Subtotal</th><th>IVU</th><th>Total</th><th>Propina</th></tr></thead>
          <tbody id="tbVentas"></tbody>
        </table>
      </div>
      <div class="card">
        <div style="display:flex; align-items:center; gap:.6rem"><b>Gastos del período</b><span class="badge no-print">Local: sp_gastos</span></div>
        <div class="row cols-3 no-print" style="margin-top:.6rem">
          <div><label>Concepto</label><input id="g_concepto" class="input" placeholder="Renta, insumos, etc."></div>
          <div><label>Fecha</label><input id="g_fecha" type="date" class="input"></div>
          <div><label>Monto</label><input id="g_monto" type="number" step=".01" class="input" placeholder="0.00"></div>
        </div>
        <div class="actions no-print" style="margin-top:.6rem">
          <button id="btnGAdd" class="btn-primary">Añadir gasto</button>
        </div>
        <table class="table" style="margin-top:.6rem">
          <thead><tr class="tr"><th>Fecha</th><th>Concepto</th><th>Monto</th><th class="no-print">Acciones</th></tr></thead>
          <tbody id="tbGastos"></tbody>
        </table>
      </div>
    </div>

  </main>

<script>
/* ======= Claves compartidas con Salon Pro ======= */
const K = {
  FACTS: 'sp_facturas',
  EMP:   'sp_empleados',
  GASTOS:'sp_gastos',
  CFGCF: 'sp_cf_cfg' // { propinas:0/1, saldo: number }
};
/* ========= Utiles ========= */
const $=s=>document.querySelector(s);
const fmt=n=>(+n||0).toLocaleString('es-PR',{style:'currency',currency:'USD'});
const todayISO=()=>new Date().toISOString().slice(0,10);
const load=(k,d=null)=>JSON.parse(localStorage.getItem(k)||JSON.stringify(d));
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const csvSafe=v=>{
  const s=String(v??''); const needs=/[",\n]/.test(s)||/^[=+\-@]/.test(s);
  return needs?`"${s.replace(/"/g,'""')}"`:s;
};
/* ========= Estado ========= */
function ensureDefaults(){
  if(!load(K.GASTOS)) save(K.GASTOS,[]);
  if(!load(K.CFGCF)) save(K.CFGCF,{propinas:0, saldo:0});
}
function fillEmps(){
  const emps = load(K.EMP,[]);
  const sel = $('#f_emp');
  sel.innerHTML = '<option value="">Todas</option>' + (emps||[]).map(e=>`<option value="${e.id}">${e.nombre||'(Sin nombre)'}</option>`).join('');
}
/* ====== Base desde sp_facturas ====== */
function getFacturaPropina(f){
  const p = Number.isFinite(f?.propina) ? +f.propina : +(f?.notas||0);
  return Number.isFinite(p) ? p : 0;
}
function rangear(facts, desde, hasta, emp){
  let arr = (facts||[]).filter(f => (!desde || f.fecha>=desde) && (!hasta || f.fecha<=hasta));
  if(emp) arr = arr.filter(f=>f.emp===emp);
  return arr;
}
function groupByMetodo(ventas){
  const map={}; let total=0;
  ventas.forEach(v=>{
    const m=(v.pago||'Otro').trim();
    map[m] = (map[m]||0) + (+v.tot||0);
    total += (+v.tot||0);
  });
  return {map,total};
}
function compute(desde, hasta, emp, incluirPropinas, saldoInicial){
  const facts = load(K.FACTS,[]);
  const ventas = rangear(facts, desde, hasta, emp).map(f=>({
    num:f.num, fecha:f.fecha, emp:f.emp, pago:f.pago,
    sub:+f.sub||0, tax:+f.tax||0, tot:+f.tot||0, prop:getFacturaPropina(f)
  }));
  const gastosAll = load(K.GASTOS,[]);
  const gastos = (gastosAll||[]).filter(g => (!desde || g.fecha>=desde) && (!hasta || g.fecha<=hasta));
  const ingresos = ventas.reduce((a,v)=>a+v.tot,0);
  const propinas = ventas.reduce((a,v)=>a+v.prop,0);
  const gastosSum = gastos.reduce((a,g)=>a+(+g.monto||0),0);
  const neto = ingresos + (incluirPropinas?propinas:0) - gastosSum; // flujo del período
  const cajaFinal = (+saldoInicial||0) + neto;
  const {map:metodos,total:ingresosCheck} = groupByMetodo(ventas);
  return {ventas, gastos, ingresos, propinas, gastosSum, neto, cajaFinal, saldoInicial:+saldoInicial||0, metodos, ingresosCheck};
}
/* ====== Render ====== */
function renderTablaVentas(ventas){
  const emps = load(K.EMP,[]);
  const empName=id=>(emps||[]).find(e=>e.id===id)?.nombre||'';
  $('#tbVentas').innerHTML = ventas.map(v=>`
    <tr class="tr">
      <td>${v.num}</td>
      <td>${v.fecha}</td>
      <td>${empName(v.emp)}</td>
      <td>${v.pago}</td>
      <td>${fmt(v.sub)}</td>
      <td>${fmt(v.tax)}</td>
      <td>${fmt(v.tot)}</td>
      <td>${fmt(v.prop)}</td>
    </tr>`).join('');
}
function renderTablaGastos(gastos){
  $('#tbGastos').innerHTML = gastos.map((g,idx)=>`
    <tr class="tr">
      <td>${g.fecha}</td>
      <td>${g.concepto}</td>
      <td>${fmt(g.monto)}</td>
      <td class="no-print">
        <button class="btn-ghost" onclick="delGasto(${idx})">Borrar</button>
      </td>
    </tr>`).join('');
}
function renderMetodos(metodos, total){
  const rows = Object.entries(metodos).sort((a,b)=>b[1]-a[1]).map(([monto, val])=>[monto,val]);
  const tbody = $('#tbMetodos');
  if(!total){ tbody.innerHTML = `<tr class="tr"><td colspan="3">Sin ventas en el período</td></tr>`; return; }
  tbody.innerHTML = Object.entries(metodos).map(([m,v])=>{
    const pct = (v/total*100).toFixed(1)+'%';
    return `<tr class="tr"><td>${m}</td><td>${fmt(v)}</td><td>${pct}</td></tr>`;
  }).join('');
}
function setKPIs({ingresos, propinas, gastosSum, neto, cajaFinal, saldoInicial}){
  $('#kpi_ingresos').textContent = fmt(ingresos);
  $('#kpi_propinas').textContent = fmt(propinas);
  $('#kpi_gastos').textContent   = fmt(gastosSum);
  $('#kpi_inicial').textContent  = fmt(saldoInicial);
  $('#kpi_neto').textContent     = fmt(neto);
  $('#kpi_final').textContent    = fmt(cajaFinal);
}
/* ====== Gráfico Canvas ====== */
function drawChart(desde, hasta, emp, incluirPropinas){
  const cvs=$('#chart'), ctx=cvs.getContext('2d');
  const W=cvs.width = cvs.clientWidth || 900, H=cvs.height;
  ctx.clearRect(0,0,W,H);
  const d0 = new Date(desde||todayISO());
  const d1 = new Date(hasta||todayISO());
  const days=[]; for(let d=new Date(d0); d<=d1; d.setDate(d.getDate()+1)){ days.push(d.toISOString().slice(0,10)); }
  const facts = load(K.FACTS,[]);
  const gastos = load(K.GASTOS,[]);
  const serie = days.map(day=>{
    const vs = rangear(facts, day, day, emp);
    const ingresos = vs.reduce((a,f)=>a+(+f.tot||0),0) + (incluirPropinas? vs.reduce((a,f)=>a+getFacturaPropina(f),0) : 0);
    const g = (gastos||[]).filter(x=>x.fecha===day).reduce((a,b)=>a+(+b.monto||0),0);
    return {day, neto: ingresos - g};
  });
  const pad=30; const max=Math.max(1, ...serie.map(s=>s.neto));
  ctx.strokeStyle='#cdd4ff'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(pad,10); ctx.lineTo(pad,H-pad); ctx.lineTo(W-10,H-pad); ctx.stroke();
  ctx.fillStyle='#9aa3c7'; ctx.font='12px sans-serif';
  for(let i=0;i<=4;i++){
    const val=max*i/4; const y=H-pad-(H-2*pad)*(val/max);
    ctx.fillText((val).toFixed(0), 4, y+4);
    ctx.strokeStyle='rgba(205,212,255,.15)';
    ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-10,y); ctx.stroke();
  }
  const dx=(W-2*pad)/(Math.max(1,serie.length-1));
  ctx.beginPath();
  serie.forEach((p,idx)=>{
    const x=pad+dx*idx;
    const y=H-pad-(H-2*pad)*((p.neto<0?0:p.neto)/max);
    if(idx===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.strokeStyle='#93c5fd'; ctx.lineWidth=2; ctx.stroke();
}
/* ====== Gastos CRUD ====== */
function addGasto(){
  const concepto = $('#g_concepto').value.trim();
  const fecha = $('#g_fecha').value || todayISO();
  const monto = +$('#g_monto').value || 0;
  if(!concepto || !monto){ alert('Concepto y monto requeridos'); return; }
  const arr = load(K.GASTOS,[]);
  arr.push({concepto, fecha, monto});
  save(K.GASTOS, arr);
  $('#g_concepto').value=''; $('#g_monto').value='';
  aplicar();
}
function delGasto(idx){
  const arr = load(K.GASTOS,[]);
  arr.splice(idx,1); save(K.GASTOS,arr); aplicar();
}
/* ====== CSV/Print ====== */
function exportCSV(){
  const desde=$('#f_desde').value, hasta=$('#f_hasta').value, emp=$('#f_emp').value;
  const ip=$('#f_propinas').value==='1'; const saldo=parseFloat($('#f_saldo').value||'0')||0;
  const res=compute(desde,hasta,emp,ip,saldo);
  let lines=[];
  // Encabezado
  lines.push(['Periodo',desde||'',hasta||''].map(csvSafe).join(','));
  lines.push(['Empleado',emp||'Todas'].map(csvSafe).join(','));
  lines.push([]);
  // Ventas
  lines.push(['Ventas','#','Fecha','Empleado','Método','Subtotal','IVU','Total','Propina'].map(csvSafe).join(','));
  res.ventas.forEach(v=> lines.push(['',v.num,v.fecha,v.emp,v.pago,v.sub,v.tax,v.tot,v.prop].map(csvSafe).join(',')));
  lines.push([]);
  // Gastos
  lines.push(['Gastos','Fecha','Concepto','Monto'].map(csvSafe).join(','));
  res.gastos.forEach(g=> lines.push(['',g.fecha,g.concepto,g.monto].map(csvSafe).join(',')));
  lines.push([]);
  // Métodos
  lines.push(['Caja por método','Método','Monto','% Ingresos'].map(csvSafe).join(','));
  Object.entries(res.metodos).forEach(([m,v])=>{
    const pct = res.ingresos ? (v/res.ingresos*100).toFixed(1)+'%' : '0%';
    lines.push(['',m,v,pct].map(csvSafe).join(','));
  });
  lines.push([]);
  // Resumen de caja
  lines.push(['Resumen','Ingresos',res.ingresos,'Propinas (incl)',ip?res.propinas:0,'Gastos',res.gastosSum,'Caja Inicial',res.saldoInicial,'Flujo Neto',res.neto,'Caja Final',res.cajaFinal].map(csvSafe).join(','));
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([lines.join('\n')],{type:'text/csv'}));
  a.download=`flujo_${desde||'inicio'}_a_${hasta||'fin'}.csv`; a.click(); URL.revokeObjectURL(a.href);
}
function printDoc(){ window.print(); }
/* ====== Helpers UI ====== */
function setPeriodoHoy(){
  const t=todayISO(); $('#f_desde').value=t; $('#f_hasta').value=t;
}
function setPeriodoMes(){
  const d=new Date(); const desde=new Date(d.getFullYear(), d.getMonth(), 1).toISOString().slice(0,10);
  const hasta=new Date(d.getFullYear(), d.getMonth()+1, 0).toISOString().slice(0,10);
  $('#f_desde').value=desde; $('#f_hasta').value=hasta;
}
function setPeriodoRango(){}
/* ====== Acciones principales ====== */
function aplicar(){
  const desde=$('#f_desde').value, hasta=$('#f_hasta').value, emp=$('#f_emp').value;
  const incluirPropinas = $('#f_propinas').value==='1';
  const saldo = parseFloat($('#f_saldo').value||'0')||0;
  // persistir preferencia
  const prev=load(K.CFGCF,{});
  save(K.CFGCF,{...prev, propinas: incluirPropinas?1:0, saldo});
  const res=compute(desde,hasta,emp,incluirPropinas,saldo);
  setKPIs(res);
  renderTablaVentas(res.ventas);
  renderTablaGastos(res.gastos);
  renderMetodos(res.metodos, res.ingresos);
  drawChart(desde||todayISO(), hasta||todayISO(), emp, incluirPropinas);
}
/* ====== Boot ====== */
function boot(){
  ensureDefaults();
  fillEmps();
  const cfg=load(K.CFGCF,{propinas:0, saldo:0});
  $('#f_propinas').value = (cfg?.propinas? '1':'0');
  $('#f_saldo').value = Number.isFinite(+cfg?.saldo) ? (+cfg.saldo) : 0;
  setPeriodoMes();
  aplicar();

  // eventos
  $('#btnHoy').onclick=()=>{setPeriodoHoy(); aplicar();};
  $('#btnMes').onclick=()=>{setPeriodoMes(); aplicar();};
  $('#btnRango').onclick=()=>{setPeriodoRango();};
  $('#btnImprimir').onclick=printDoc;
  $('#btnCSV').onclick=exportCSV;
  $('#btnAplicar').onclick=aplicar;
  $('#btnReset').onclick=()=>{ setPeriodoMes(); $('#f_emp').value=''; $('#f_propinas').value='0'; $('#f_saldo').value = 0; aplicar(); };
  $('#btnGAdd').onclick=addGasto;
}
window.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>

