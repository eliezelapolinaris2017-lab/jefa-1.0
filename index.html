<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Salon Pro ‚Äî Facturaci√≥n & Citas</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f0f12">
<style>
/* =========================
   THEME / DISE√ëO ELEGANTE
   ========================= */
:root{
  /* Colores base (100% editables en Configuraci√≥n) */
  --bg:#0f0f12;
  --fg:#ffffff;
  --muted:#a7a7b1;
  --primary:#6ee7b7;
  --primary-2:#22c55e;
  --accent:#93c5fd;
  --danger:#ef4444;
  --warn:#f59e0b;
  --card:#171821;
  --card-2:#1e202b;
  --topbar:#11121a;
  --footer:#0c0d12;
  --btn:#24263a;
  --outline:#2a2d40;
  --shadow:0 10px 30px rgba(0,0,0,.35);
  --radius:18px;
  --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, "Helvetica Neue", Arial;
  --bg-opacity:1; /* 1 = s√≥lido, 0.75 = trasl√∫cido */
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background: rgba(15,15,18,var(--bg-opacity));
  color:var(--fg); font-family:var(--font); -webkit-font-smoothing:antialiased;
  background-image: var(--bg-image, none);
  background-size: cover; background-position:center; background-attachment:fixed;
}
a{color:inherit; text-decoration:none}
button{cursor:pointer; border:0; background:var(--btn); color:#fff; border-radius:12px; padding:.8rem 1rem; box-shadow:var(--shadow); transition:transform .18s ease, opacity .18s ease}
button:hover{transform:translateY(-1px)}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--accent))}
.btn-danger{background:linear-gradient(135deg,var(--danger),#b91c1c)}
.btn-warn{background:linear-gradient(135deg,var(--warn),#f59e0b)}
.btn-ghost{background:transparent; border:1px solid var(--outline)}
.input, select, textarea{
  width:100%; padding:.78rem .9rem; background:#11131a; color:#fff; border:1px solid var(--outline);
  border-radius:12px; outline:none; transition:border-color .15s ease, box-shadow .15s ease
}
.input:focus, select:focus, textarea:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(147,197,253,.25)}
label{display:block; font-size:.9rem; color:var(--muted); margin:.1rem 0 .35rem}
.card{
  background: linear-gradient(180deg, var(--card), var(--card-2));
  border:1px solid var(--outline);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding:1.1rem;
}
.row{display:grid; gap:1rem}
.row.cols-2{grid-template-columns:1fr 1fr}
.row.cols-3{grid-template-columns:repeat(3,1fr)}
.row.cols-4{grid-template-columns:repeat(4,1fr)}
@media (max-width:980px){
  .row.cols-2,.row.cols-3,.row.cols-4{grid-template-columns:1fr}
}
.table{width:100%; border-collapse:separate; border-spacing:0 10px}
.table th, .table td{padding:.75rem .9rem; text-align:left}
.table thead th{color:#cdd4ff; font-weight:600; font-size:.9rem}
.tr{
  background: linear-gradient(180deg,#141726,#0f1220);
  border:1px solid var(--outline);
  border-radius:12px;
}
.tr td:first-child,.tr th:first-child{border-top-left-radius:12px; border-bottom-left-radius:12px}
.tr td:last-child,.tr th:last-child{border-top-right-radius:12px; border-bottom-right-radius:12px}
.badge{display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .6rem; background:#101323; border:1px solid var(--outline); border-radius:999px; font-size:.78rem; color:#c7d2fe}
.kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:1rem}
.kpi{padding:1rem; border-radius:16px; background:#10121a; border:1px solid var(--outline)}
.kpi .label{color:#b5bad6; font-size:.85rem}
.kpi .value{font-size:1.4rem; font-weight:700}
.topbar{
  position:sticky; top:0; z-index:50;
  background: linear-gradient(180deg,var(--topbar), rgba(17,18,26,.85));
  backdrop-filter: blur(8px);
  border-bottom:1px solid var(--outline);
}
.topbar-inner{display:flex; align-items:center; gap:1rem; padding:.8rem 1rem}
.brand{display:flex; align-items:center; gap:.7rem}
.brand img{width:36px; height:36px; border-radius:10px; object-fit:cover; border:1px solid var(--outline)}
.brand .title{font-weight:800; letter-spacing:.2px}
.top-actions{margin-left:auto; display:flex; gap:.5rem; align-items:center}
.top-actions .avatar{width:34px; height:34px; border-radius:50%; background:#0f1118; border:1px solid var(--outline)}
.container{max-width:1160px; margin:1.2rem auto; padding:0 1rem 4rem}
.footer{
  margin-top:3rem; padding:1.2rem; text-align:center; color:#9aa3c7;
  border-top:1px solid var(--outline); background:var(--footer)
}
.screen{display:none}
.screen.active{display:block; animation:fade .18s ease}
@keyframes fade{from{opacity:.5; transform:translateY(2px)} to{opacity:1; transform:none}}
.menu-grid{display:grid; grid-template-columns:repeat(3,1fr); gap:1rem}
.menu-card{display:flex; flex-direction:column; gap:.75rem; padding:1.1rem; border-radius:18px; border:1px solid var(--outline); background:linear-gradient(180deg,#121422,#0d1020)}
.menu-card h3{margin:0; font-size:1.05rem}
.menu-card p{margin:0; color:#aeb6d9; font-size:.9rem}
.menu-card .actions{display:flex; gap:.6rem; margin-top:.6rem; flex-wrap:wrap}
.backline{display:flex; align-items:center; gap:.7rem; margin-bottom:1rem}
.backline button{padding:.6rem .8rem}
.small{font-size:.85rem}
.right{margin-left:auto}
.help{color:#a9b2dc; font-size:.85rem}
.login-wrap{max-width:440px; margin:6vh auto}
.logo-preview{width:56px; height:56px; border-radius:12px; object-fit:cover; border:1px solid var(--outline); background:#0e1020}
.center{text-align:center}
hr.sep{border:0; height:1px; background:linear-gradient(90deg, transparent, #28304a, transparent); margin:1rem 0}
.chips{display:flex; gap:.5rem; flex-wrap:wrap}
.chip{padding:.35rem .6rem; border-radius:999px; border:1px solid var(--outline); background:#0c0f1e; color:#c7cff7; font-size:.78rem}
.preview{width:100%; max-height:220px; object-fit:contain; background:#0b0e1a; border:1px dashed var(--outline); border-radius:12px; padding:.6rem}
.toolbar{display:flex; gap:.5rem; align-items:center; flex-wrap:wrap}
.spacer{flex:1}
.hidden{display:none !important}
@media print{
  body{background:white !important; color:black !important}
  .topbar, .footer, .no-print{display:none !important}
  .card, .tr{box-shadow:none; border:1px solid #ddd}
}
</style>
</head>
<body>
<header class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <img id="brandLogo" alt="logo">
      <div>
        <div class="title" id="brandName">Salon Pro</div>
        <div class="small" id="brandSub">Agenda & Facturaci√≥n</div>
      </div>
    </div>
    <div class="top-actions no-print">
      <button id="btnHome" class="btn-ghost" title="Men√∫">Men√∫</button>
      <button id="btnConfig" class="btn-ghost" title="Configuraci√≥n">Config</button>
      <button id="btnLogout" class="btn-danger" title="Salir">Salir</button>
      <div class="avatar" title="Usuario" id="whoami"></div>
    </div>
  </div>
</header>

<main class="container">
  <!-- LOGIN -->
  <section id="screen-login" class="screen active">
    <div class="login-wrap">
      <div class="center">
        <img id="loginLogo" class="logo-preview" alt="Logo">
        <h1 style="margin:.6rem 0 0">Bienvenido</h1>
        <p class="help">Inicia sesi√≥n para continuar</p>
      </div>
      <div class="card" style="margin-top:1rem">
        <div class="row cols-2">
          <div>
            <label>Usuario</label>
            <input id="loginUser" class="input" placeholder="admin o usuario">
          </div>
          <div>
            <label>Contrase√±a</label>
            <input id="loginPass" type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
        </div>
        <div class="row" style="margin-top:.8rem">
          <button id="doLogin" class="btn-primary">Entrar</button>
          <div class="chips">
            <span class="chip">admin / admin123 (admin)</span>
            <span class="chip">usuario / user123 (usuario)</span>
          </div>
        </div>
      </div>
      <hr class="sep">
      <div class="card">
        <b>Notas</b>
        <p class="help">El rol <b>admin</b> ve todo; el <b>usuario</b> solo Agenda y Facturaci√≥n.</p>
      </div>
    </div>
  </section>

  <!-- INICIO / MEN√ö -->
  <section id="screen-home" class="screen">
    <div class="row">
      <div class="backline no-print">
        <h2 style="margin:0">Men√∫ principal</h2>
        <span class="spacer"></span>
        <span class="help">Selecciona una secci√≥n</span>
      </div>
      <div class="menu-grid">
        <div class="menu-card">
          <h3>Agenda de citas</h3>
          <p>Crear, listar, evitar duplicados, ‚Äúno show‚Äù, WhatsApp y Google.</p>
          <div class="actions"><button class="btn-primary" data-goto="screen-agenda">Abrir Agenda</button></div>
        </div>
        <div class="menu-card">
          <h3>Facturaci√≥n</h3>
          <p>Genera facturas y env√≠alas por WhatsApp. Exporta PDF/CSV.</p>
          <div class="actions"><button class="btn-primary" data-goto="screen-facturacion">Abrir Facturaci√≥n</button></div>
        </div>
        <div class="menu-card">
          <h3>Panel Administrativo</h3>
          <p>Confirmaci√≥n 24h (WhatsApp), Propinas por t√©cnica y Exportaciones.</p>
          <div class="actions"><button class="btn-primary" data-goto="screen-export">Abrir Panel</button></div>
        </div>
        <div class="menu-card">
          <h3>An√°lisis de rendimiento</h3>
          <p>KPIs y gr√°fica 30 d√≠as.</p>
          <div class="actions"><button class="btn-primary" data-goto="screen-analytics">Ver An√°lisis</button></div>
        </div>
        <div class="menu-card">
          <h3>Empleados</h3>
          <p>A√±ade / edita empleados para agenda y facturas.</p>
          <div class="actions"><button class="btn-primary" data-goto="screen-empleados">Gestionar</button></div>
        </div>
        <div class="menu-card">
          <h3>Configuraci√≥n</h3>
          <p>Colores, logo, fondo, Google, ATH M√≥vil, exportar/importar.</p>
          <div class="actions"><button class="btn-primary" data-goto="screen-config">Abrir Config</button></div>
        </div>
      </div>
    </div>
  </section>

  <!-- AGENDA -->
  <section id="screen-agenda" class="screen">
    <div class="backline">
      <button class="btn-ghost" data-goto="screen-home">‚Üê Regresar</button>
      <h2 style="margin:0">Agenda de Citas</h2>
      <span class="spacer"></span>
      <button id="btnAgendaImprimir" class="btn-ghost no-print">Imprimir</button>
    </div>

    <div class="card">
      <div class="row cols-4">
        <div><label>Cliente</label><input id="a_nombre" class="input" placeholder="Nombre y apellidos"></div>
        <div><label>Tel√©fono</label><input id="a_tel" class="input" placeholder="+1 787 000 0000"></div>
        <div><label>Empleado/T√©cnica</label><select id="a_emp" class="input"></select></div>
        <div><label>Servicio</label><input id="a_srv" class="input" placeholder="Corte, color, etc."></div>
      </div>
      <div class="row cols-4" style="margin-top:.6rem">
        <div><label>Fecha</label><input id="a_fecha" type="date" class="input"></div>
        <div><label>Hora</label><input id="a_hora" type="time" class="input" step="900"></div>
        <div><label>Duraci√≥n (min)</label><input id="a_dur" type="number" class="input" value="60" min="15" step="15"></div>
        <div><label>Notas</label><input id="a_notas" class="input" placeholder="Observaciones"></div>
      </div>
      <div class="toolbar" style="margin-top:.7rem">
        <button id="btnAgendaGuardar" class="btn-primary">Guardar cita</button>
        <button id="btnAgendaNoShow" class="btn-warn">Marcar No Show</button>
        <div class="spacer"></div>
        <button id="btnAgendaGoogle" class="btn-ghost">Enviar a Google Form</button>
        <button id="btnAgendaGoogleTest" class="btn-ghost">Probar env√≠o (abrir)</button>
        <button id="btnAgendaWhatsApp" class="btn-ghost">WhatsApp confirmaci√≥n</button>
      </div>
    </div>

    <div class="row" style="margin-top:1rem">
      <div class="card">
        <div class="toolbar">
          <b>Listado de citas</b>
          <div class="spacer"></div>
          <label class="small">Filtrar por fecha</label>
          <input id="f_fecha" type="date" class="input" style="width:auto">
          <label class="small">Empleado</label>
          <select id="f_emp" class="input" style="width:auto"></select>
          <button id="btnAgendaFiltrar" class="btn-ghost">Aplicar</button>
        </div>
        <table class="table" id="tblCitas">
          <thead><tr class="tr">
            <th>Fecha</th><th>Hora</th><th>Cliente</th><th>Empleado</th><th>Servicio</th><th>Tel</th><th>Estado</th><th class="no-print">Acciones</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- FACTURACI√ìN -->
  <section id="screen-facturacion" class="screen">
  <div class="backline">
    <button class="btn-ghost" data-goto="screen-home">‚Üê Regresar</button>
    <h2 style="margin:0">Facturaci√≥n</h2>
    <span class="spacer"></span>
    <button id="btnFacturaImprimir" class="btn-ghost no-print">Imprimir</button>
  </div>

  <!-- SUBTABS -->
  <style>
    .subtabs{display:flex; gap:.5rem; flex-wrap:wrap; border-bottom:1px solid var(--outline); padding-bottom:.6rem; margin-bottom:1rem}
    .subtab{background:transparent; border:1px solid var(--outline); padding:.55rem .9rem; border-radius:999px; cursor:pointer}
    .subtab.active{background:linear-gradient(135deg,var(--primary),var(--accent)); color:#000; border-color:transparent}
    .subsection{display:none}
    .subsection.active{display:block}
  </style>
  <div class="subtabs no-print">
    <button class="subtab active" id="cf_tab_facturar">Facturar</button>
    <button class="subtab" id="cf_tab_flujo">Flujo de Caja</button>
  </div>

  <!-- =================== SUBTAB: FACTURAR (TU ORIGINAL) =================== -->
  <div id="cf_view_facturar" class="subsection active">

    <div class="card">
      <div class="row cols-4">
        <div><label># Factura</label><input id="f_num" class="input" placeholder="AUTOM√ÅTICO" disabled></div>
        <div><label>Cliente</label><input id="f_cli" class="input" placeholder="Nombre y apellidos"></div>
        <div><label>Tel√©fono</label><input id="f_tel" class="input" placeholder="+1 787 ..."></div>
        <div><label>Empleado</label><select id="ff_emp" class="input"></select></div>
      </div>
      <div class="row cols-4" style="margin-top:.6rem">
        <div><label>Fecha</label><input id="f_fecha" type="date" class="input"></div>
        <div><label>M√©todo de pago</label>
          <select id="f_pago" class="input"><option>ATH M√≥vil</option><option>Tarjeta</option><option>Cash</option></select>
        </div>
        <div><label>IVU %</label><input id="f_ivu" type="number" class="input" value="11.5" step=".1" min="0"></div>
        <div><label>Propinas</label><input id="f_propina" type="number" step=".01" min="0" class="input" placeholder="0.00" value="0"></div>
      </div>
      <div class="row" style="margin-top:.6rem">
        <div class="toolbar">
          <b>Conceptos</b>
          <div class="spacer"></div>
          <button id="btnAddLinea" class="btn-ghost">A√±adir l√≠nea</button>
          <button id="btnLoadServicios" class="btn-ghost">Servicios guardados</button>
        </div>
        <div id="lineas"></div>
        <hr class="sep">
        <div class="row cols-3">
          <div class="card">
            <div class="row cols-2">
              <div><label>Subtotal</label><input id="f_sub" class="input" disabled></div>
              <div><label>IVU</label><input id="f_tax" class="input" disabled></div>
            </div>
            <div class="row" style="margin-top:.6rem">
              <label>Total</label><input id="f_total" class="input" disabled>
            </div>
          </div>
          <div class="card">
            <b>ATH M√≥vil / QR</b>
            <div class="row">
              <input id="ath_alias" class="input" placeholder="Alias o N√∫mero de ATH M√≥vil">
              <input id="ath_monto" class="input" placeholder="Monto a cobrar (auto)" disabled>
              <label class="small">Sube tu c√≥digo QR</label>
              <input id="ath_qr" type="file" accept="image/*" class="input">
              <img id="ath_preview" class="preview" alt="QR ATH M√≥vil">
            </div>
          </div>
          <div class="card">
            <b>Acciones</b>
            <div class="row">
              <button id="btnFacturaGuardar" class="btn-primary">Guardar Factura</button>
              <button id="btnFacturaWhatsApp" class="btn-ghost">Enviar por WhatsApp</button>
              <button id="btnFacturaExportPDF" class="btn-ghost">Exportar PDF (Imprimir)</button>
              <button id="btnFacturaExportCSV" class="btn-ghost">Exportar Excel (CSV)</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:1rem">
      <div class="card">
        <div class="toolbar">
          <b>Historial de facturas</b>
          <div class="spacer"></div>
          <label class="small">Rango</label>
          <input id="h_desde" type="date" class="input" style="width:auto">
          <input id="h_hasta" type="date" class="input" style="width:auto">
          <label class="small">Empleado</label>
          <select id="h_emp" class="input" style="width:auto"></select>
          <button id="btnHistFiltrar" class="btn-ghost">Filtrar</button>
        </div>
        <table class="table" id="tblFacturas">
          <thead><tr class="tr">
            <th>#</th><th>Fecha</th><th>Cliente</th><th>Empleado</th><th>M√©todo</th><th>Total</th><th class="no-print">Acciones</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>
  <!-- =================== /SUBTAB FACTURAR =================== -->

  <!-- =================== SUBTAB: FLUJO DE CAJA =================== -->
  <div id="cf_view_flujo" class="subsection">

    <div class="card">
      <div style="display:flex; align-items:center; gap:.8rem; flex-wrap:wrap">
        <b>Panel de control ‚Äî Flujo de Caja</b>
        <div class="actions" style="margin-left:auto">
          <button id="cf_btnHoy" class="btn-ghost">Hoy</button>
          <button id="cf_btnMes" class="btn-ghost">Mes</button>
          <button id="cf_btnRango" class="btn-ghost">Rango</button>
          <button id="cf_btnPDF" class="btn-primary">Reporte PDF</button>
          <button id="cf_btnCSV" class="btn-ghost">Exportar CSV</button>
        </div>
      </div>
      <p class="help">Lee ventas de <code>sp_facturas</code>. Guarda gastos en <code>sp_gastos</code> y movimientos en <code>sp_cf_movs</code>.</p>
    </div>

    <!-- Filtros -->
    <div class="card" style="margin-top:1rem">
      <div class="row cols-4">
        <div><label>Desde</label><input id="cf_desde" type="date" class="input"></div>
        <div><label>Hasta</label><input id="cf_hasta" type="date" class="input"></div>
        <div>
          <label>Empleado/T√©cnica</label>
          <select id="cf_emp" class="input"></select>
        </div>
        <div>
          <label>Incluir propinas en caja</label>
          <select id="cf_propinas" class="input">
            <option value="0">No (solo ventas)</option>
            <option value="1">S√≠ (sumar propinas)</option>
          </select>
        </div>
      </div>
      <div class="row cols-4" style="margin-top:.6rem">
        <div><label>Saldo inicial de caja</label><input id="cf_saldo" type="number" step=".01" class="input" placeholder="0.00"></div>
        <div class="actions" style="align-items:end">
          <button id="cf_btnAplicar" class="btn-primary">Aplicar</button>
          <button id="cf_btnReset" class="btn-ghost">Reset</button>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpis" style="margin-top:1rem">
      <div class="kpi"><div class="label">Ingresos</div><div class="value" id="cf_kpi_ingresos">$0</div></div>
      <div class="kpi"><div class="label">Propinas</div><div class="value" id="cf_kpi_propinas">$0</div></div>
      <div class="kpi"><div class="label">Gastos</div><div class="value" id="cf_kpi_gastos">$0</div></div>
      <div class="kpi"><div class="label">Caja Inicial</div><div class="value" id="cf_kpi_inicial">$0</div></div>
      <div class="kpi"><div class="label">Flujo Neto</div><div class="value" id="cf_kpi_neto">$0</div></div>
      <div class="kpi"><div class="label">Caja Final</div><div class="value" id="cf_kpi_final">$0</div></div>
    </div>

    <!-- Gr√°fica -->
    <div class="card" style="margin-top:1rem">
      <div style="display:flex; align-items:center">
        <b>Flujo diario (ingresos - gastos)</b>
        <span style="margin-left:auto; color:#a9b2dc; font-size:.9rem">Canvas sin librer√≠as</span>
      </div>
      <canvas id="cf_chart" height="190" style="width:100%"></canvas>
    </div>

    <!-- Caja por m√©todo -->
    <div class="card" style="margin-top:1rem">
      <b>Caja por m√©todo de pago</b>
      <table class="table">
        <thead><tr class="tr"><th>M√©todo</th><th>Monto</th><th>% Ingresos</th></tr></thead>
        <tbody id="cf_tbMetodos"></tbody>
      </table>
    </div>

    <!-- Resumen por t√©cnica -->
    <div class="card" style="margin-top:1rem">
      <b>Resumen por t√©cnica</b>
      <table class="table">
        <thead><tr class="tr"><th>T√©cnica</th><th>Ventas</th><th>Propinas</th></tr></thead>
        <tbody id="cf_tbTecnicas"></tbody>
      </table>
    </div>

    <!-- Resumen diario -->
    <div class="card" style="margin-top:1rem">
      <div style="display:flex; align-items:center; gap:.6rem">
        <b>Resumen diario</b>
        <div class="actions no-print" style="margin-left:auto">
          <label class="small">Filtrar m√©todo:</label>
          <select id="cf_metodo" class="input" style="width:auto">
            <option value="">Todos</option>
            <option>ATH M√≥vil</option>
            <option>Tarjeta</option>
            <option>Cash</option>
          </select>
        </div>
      </div>
      <table class="table" style="margin-top:.6rem">
        <thead><tr class="tr"><th>Fecha</th><th>Ventas</th><th>Propinas</th><th>Gastos</th><th>Neto</th></tr></thead>
        <tbody id="cf_tbDiario"></tbody>
      </table>
    </div>

    <!-- Movimientos (retiros/dep√≥sitos) -->
    <div class="card" style="margin-top:1rem">
      <div style="display:flex; align-items:center; gap:.6rem">
        <b>Movimientos de caja (retiros/dep√≥sitos)</b>
        <span class="badge no-print">Ajustan la caja final</span>
      </div>
      <div class="row cols-3 no-print" style="margin-top:.6rem">
        <div><label>Tipo</label><select id="cf_m_tipo" class="input"><option>Retiro</option><option>Dep√≥sito</option></select></div>
        <div><label>Fecha</label><input id="cf_m_fecha" type="date" class="input"></div>
        <div><label>Monto</label><input id="cf_m_monto" type="number" step=".01" class="input" placeholder="0.00"></div>
      </div>
      <div class="actions no-print" style="margin-top:.6rem">
        <button id="cf_btnMAdd" class="btn-primary">A√±adir movimiento</button>
      </div>
      <table class="table" style="margin-top:.6rem">
        <thead><tr class="tr"><th>Fecha</th><th>Tipo</th><th>Monto</th><th class="no-print">Acciones</th></tr></thead>
        <tbody id="cf_tbMovs"></tbody>
      </table>
    </div>

    <!-- Detalle ventas / gastos -->
    <div class="row cols-2" style="margin-top:1rem">
      <div class="card">
        <b>Ventas del per√≠odo</b>
        <table class="table">
          <thead><tr class="tr"><th>#</th><th>Fecha</th><th>T√©cnica</th><th>M√©todo</th><th>Subtotal</th><th>IVU</th><th>Total</th><th>Propina</th></tr></thead>
        <tbody id="cf_tbVentas"></tbody>
        </table>
      </div>
      <div class="card">
        <div style="display:flex; align-items:center; gap:.6rem">
          <b>Gastos del per√≠odo</b><span class="badge no-print">Local: sp_gastos</span>
        </div>
        <div class="row cols-3 no-print" style="margin-top:.6rem">
          <div><label>Concepto</label><input id="cf_g_concepto" class="input" placeholder="Renta, insumos, etc."></div>
          <div><label>Fecha</label><input id="cf_g_fecha" type="date" class="input"></div>
          <div><label>Monto</label><input id="cf_g_monto" type="number" step=".01" class="input" placeholder="0.00"></div>
        </div>
        <div class="actions no-print" style="margin-top:.6rem">
          <button id="cf_btnGAdd" class="btn-primary">A√±adir gasto</button>
        </div>
        <table class="table" style="margin-top:.6rem">
          <thead><tr class="tr"><th>Fecha</th><th>Concepto</th><th>Monto</th><th class="no-print">Acciones</th></tr></thead>
          <tbody id="cf_tbGastos"></tbody>
        </table>
      </div>
    </div>

  </div>
  <!-- =================== /SUBTAB FLUJO =================== -->

</section>


  <!-- PANEL ADMINISTRATIVO -->
  <section id="screen-export" class="screen">
    <div class="backline">
      <button class="btn-ghost" data-goto="screen-home">‚Üê Regresar</button>
      <h2 style="margin:0">Panel Administrativo</h2>
    </div>

    <!-- Confirmaci√≥n 24h -->
    <div class="card">
      <b>Confirmaci√≥n de Citas ‚Äî 24 horas antes</b>
      <div class="row cols-4" style="margin-top:.6rem">
        <div><label>Fecha base</label><input id="adm_base" type="date" class="input"></div>
        <div><label>Empleado</label><select id="adm_emp" class="input"></select></div>
        <div><label>&nbsp;</label><button id="adm_aplicar" class="btn-ghost">Aplicar</button></div>
        <div><label>&nbsp;</label><button id="adm_wa_all" class="btn-primary">Enviar WhatsApp a todos</button></div>
      </div>
      <table class="table" style="margin-top:.6rem">
        <thead><tr class="tr"><th>Fecha</th><th>Hora</th><th>Cliente</th><th>T√©cnica</th><th>Servicio</th><th>Tel</th><th class="no-print">Acciones</th></tr></thead>
        <tbody id="adm_tbl"></tbody>
      </table>
    </div>

    <!-- Exportaciones -->
    <div class="card" style="margin-top:1rem">
      <b>Exportaciones</b>
      <div class="row cols-4" style="margin-top:.6rem">
        <div>
          <label>Tipo</label>
          <select id="ex_tipo" class="input">
            <option value="facturas">Facturas</option>
            <option value="citas">Citas</option>
          </select>
        </div>
        <div>
          <label>Empleado</label>
          <select id="ex_emp" class="input"></select>
        </div>
        <div>
          <label>Per√≠odo</label>
          <select id="ex_periodo" class="input">
            <option value="dia">D√≠a</option>
            <option value="semana">Semana</option>
            <option value="mes">Mes</option>
            <option value="anio">A√±o</option>
            <option value="rango">Rango personalizado</option>
          </select>
        </div>
        <div>
          <label>Fecha base / inicio</label>
          <input id="ex_fecha" type="date" class="input">
        </div>
      </div>
      <div class="row cols-2" style="margin-top:.6rem" id="ex_rango_wrap">
        <div><label>Desde</label><input id="ex_desde" type="date" class="input"></div>
        <div><label>Hasta</label><input id="ex_hasta" type="date" class="input"></div>
      </div>
      <div class="toolbar" style="margin-top:.8rem">
        <button id="btnExportCSV" class="btn-ghost">Exportar Excel (CSV)</button>
        <button id="btnExportPrint" class="btn-ghost">Exportar PDF (Imprimir)</button>
      </div>
    </div>

    <div class="card" style="margin-top:1rem">
      <b>Vista previa</b>
      <table class="table" id="tblExport">
        <thead><tr class="tr" id="exHead"></tr></thead>
        <tbody id="exBody"></tbody>
      </table>
    </div>
  </section>

  <!-- ANALYTICS -->
  <section id="screen-analytics" class="screen">
    <div class="backline">
      <button class="btn-ghost" data-goto="screen-home">‚Üê Regresar</button>
      <h2 style="margin:0">An√°lisis de rendimiento</h2>
    </div>

    <div class="kpis">
      <div class="kpi"><div class="label">Ingresos (hoy)</div><div class="value" id="kpi_ingresos_hoy">$0</div></div>
      <div class="kpi"><div class="label">Ingresos (mes)</div><div class="value" id="kpi_ingresos_mes">$0</div></div>
      <div class="kpi"><div class="label">Citas (hoy)</div><div class="value" id="kpi_citas_hoy">0</div></div>
      <div class="kpi"><div class="label">No Shows (mes)</div><div class="value" id="kpi_noshow_mes">0</div></div>
    </div>

    <div class="row" style="margin-top:1rem">
      <div class="card">
        <div class="toolbar">
          <b>Ingresos diarios (√∫ltimos 30 d√≠as)</b>
          <div class="spacer"></div><span class="help">Gr√°fica canvas sin librer√≠as</span>
        </div>
        <canvas id="chart30" height="180"></canvas>
      </div>
    </div>
  </section>

  <!-- EMPLEADOS -->
  <section id="screen-empleados" class="screen">
    <div class="backline">
      <button class="btn-ghost" data-goto="screen-home">‚Üê Regresar</button>
      <h2 style="margin:0">Empleados / T√©cnicas</h2>
    </div>
    <div class="card">
      <div class="row cols-3">
        <div><label>Nombre</label><input id="e_nombre" class="input" placeholder="Jane Doe"></div>
        <div><label>Tel√©fono</label><input id="e_tel" class="input" placeholder="+1 787 ..."></div>
        <div><label>Activo</label>
          <select id="e_activo" class="input"><option value="1">S√≠</option><option value="0">No</option></select>
        </div>
      </div>
      <div class="toolbar" style="margin-top:.8rem">
        <button id="btnEmpGuardar" class="btn-primary">A√±adir / Actualizar</button>
        <button id="btnEmpLimpiar" class="btn-ghost">Limpiar</button>
      </div>
    </div>
    <div class="card" style="margin-top:1rem">
      <table class="table" id="tblEmpleados">
        <thead><tr class="tr"><th>Nombre</th><th>Tel</th><th>Estado</th><th class="no-print">Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- CONFIGURACI√ìN -->
  <section id="screen-config" class="screen">
    <div class="backline">
      <button class="btn-ghost" data-goto="screen-home">‚Üê Regresar</button>
      <h2 style="margin:0">Configuraci√≥n</h2>
      <span class="spacer"></span>
      <button id="btnExportConfig" class="btn-ghost">Exportar configuraci√≥n</button>
      <label class="small">Importar</label><input id="cfgImport" type="file" accept="application/json" class="input" style="width:auto">
      <button id="btnCfgAplicar" class="btn-primary" style="margin-left:.5rem">Aplicar cambios</button>
    </div>

    <div class="card">
      <b>Branding</b>
      <div class="row cols-4">
        <div><label>Nombre del negocio</label><input id="cfg_name" class="input" placeholder="Salon Pro"></div>
        <div><label>Lema / Subt√≠tulo</label><input id="cfg_sub" class="input" placeholder="Agenda & Facturaci√≥n"></div>
        <div><label>Logo</label><input id="cfg_logo" type="file" accept="image/*" class="input"></div>
        <div><label>Previsualizaci√≥n</label><img id="cfg_logo_prev" class="preview" alt="Logo"></div>
      </div>
      <div class="row cols-4" style="margin-top:.6rem">
        <div><label>Fondo (imagen)</label><input id="cfg_bg" type="file" accept="image/*" class="input"></div>
        <div><label>Opacidad de fondo (0.6 a 1)</label><input id="cfg_bg_op" type="number" step=".05" min="0.6" max="1" value="1" class="input"></div>
        <div><label>Color primario</label><input id="cfg_primary" type="color" class="input" value="#6ee7b7"></div>
        <div><label>Color acento</label><input id="cfg_accent" type="color" class="input" value="#93c5fd"></div>
      </div>
    </div>

    <div class="card" style="margin-top:1rem">
      <b>Servicios guardados (para facturaci√≥n)</b>
      <div class="row cols-3">
        <div><label>Servicio</label><input id="sv_nombre" class="input" placeholder="Corte de cabello"></div>
        <div><label>Precio</label><input id="sv_precio" type="number" step=".01" class="input" placeholder="25.00"></div>
        <div style="display:flex; align-items:flex-end"><button id="btnSvAgregar" class="btn-ghost">Agregar servicio</button></div>
      </div>
      <div class="row" style="margin-top:.6rem">
        <table class="table" id="tblServicios">
          <thead><tr class="tr"><th>Servicio</th><th>Precio</th><th class="no-print">Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:1rem">
      <b>Integraci√≥n Google (Form + Apps Script)</b>
      <div class="row cols-2">
        <div>
          <label>URL de Google Form (respuesta)</label>
          <input id="cfg_form_url" class="input" placeholder="https://docs.google.com/forms/d/e/.../formResponse">
          <p class="help">Se usa para enviar citas por POST. Debe apuntar a <code>.../formResponse</code>.</p>
        </div>
        <div>
          <label>URL Web App Apps Script (opcional)</label>
          <input id="cfg_script_url" class="input" placeholder="https://script.google.com/macros/s/.../exec">
          <p class="help">Para guardar/leer datos desde Google Sheets (como base de datos).</p>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:1rem">
      <b>WhatsApp / Direcci√≥n</b>
      <div class="row cols-3">
        <div><label>Tel√©fono WhatsApp</label><input id="cfg_wa_phone" class="input" placeholder="+1 787 000 0000"></div>
        <div><label>Texto base facturas</label><input id="cfg_wa_fact" class="input" placeholder="Gracias por su compra. Detalle:"></div>
        <div><label>Ubicaci√≥n (Maps URL)</label><input id="cfg_maps" class="input" placeholder="https://maps.google.com/?q=..."></div>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="footer">
    <div>¬© <span id="year"></span> <span id="footerName">Salon Pro</span> ‚Äî Todos los derechos reservados.</div>
  </footer>
</main>

<!-- JS APP -->
<script>
/* ============================================================
  STORAGE KEYS
  ============================================================= */
const K = {
  USERS: 'sp_users',
  SESSION: 'sp_session',
  EMP: 'sp_empleados',
  CITAS: 'sp_citas',
  FACTS: 'sp_facturas',
  CFG: 'sp_config',
  SVC: 'sp_servicios',
  COUNTER_F: 'sp_fact_counter'
};

/* ============================================================
  UTILIDADES
  ============================================================= */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const byId = id => document.getElementById(id);
const fmtMoney = n => (Number(n||0)).toLocaleString('es-PR',{style:'currency',currency:'USD'});
const todayISO = () => new Date().toISOString().slice(0,10);
const uuid = () => crypto.randomUUID ? crypto.randomUUID() : (Date.now().toString(36)+Math.random().toString(36).slice(2));
const save = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
const load = (k,d=null)=>JSON.parse(localStorage.getItem(k)||JSON.stringify(d));
const download = (filename, content, type='text/plain')=>{
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([content],{type}));
  a.download=filename; a.click(); URL.revokeObjectURL(a.href);
};
// CSV seguro (coma, saltos, comillas, e inyecci√≥n de f√≥rmulas)
function csvSafe(v){
  const s = String(v ?? '');
  const needsQuote = /[",\n]/.test(s) || /^[=+\-@]/.test(s);
  const esc = s.replace(/"/g,'""');
  return needsQuote ? `"${esc}"` : esc;
}

/* ============================================================
  ESTADO INICIAL / DEMO USERS
  ============================================================= */
function ensureDefaults(){
  if(!load(K.USERS)) save(K.USERS, [
    {user:'admin', pass:'admin123', role:'admin'},
    {user:'usuario', pass:'user123', role:'usuario'}
  ]);
  if(!load(K.EMP)) save(K.EMP, [
    {id:uuid(), nombre:'Cynthia', tel:'', activo:1},
    {id:uuid(), nombre:'Mar√≠a', tel:'', activo:1}
  ]);
  if(load(K.COUNTER_F)==null) save(K.COUNTER_F, 1001);
  if(!load(K.CFG)) save(K.CFG, {
    name:'Salon Pro', sub:'Agenda & Facturaci√≥n',
    primary:'#6ee7b7', accent:'#93c5fd', bgOpacity:1,
    logo:null, bg:null,
    formUrl:'https://docs.google.com/forms/d/e/1FAIpQLSf1UXh09WVyDvNF0tvzPEUQGsArmm81Ice53xoWgzpY-8Ae8g/formResponse',
    scriptUrl:'',
    waPhone:'17870000000', waFacto:'Gracias por su visita. Detalle:',
    maps:'',
    formMap:{
      nombre:"entry.126099183",
      tel:"entry.885012759",
      fecha:"entry.2059036119",
      hora:"entry.805023101",
      servicio:"entry.1764664020",
      tecnica:"entry.1003942216",
      correo:"entry.1481210954"
    }
  });
  if(!load(K.SVC)) save(K.SVC, [
    {id:uuid(), nombre:'Corte de cabello', precio:25},
    {id:uuid(), nombre:'Color', precio:60}
  ]);
  if(!load(K.CITAS)) save(K.CITAS, []);
  if(!load(K.FACTS)) save(K.FACTS, []);
}

/* ============================================================
  TEMA / BRAND
  ============================================================= */
function applyBrand(){
  const cfg=load(K.CFG,{});
  byId('brandName').textContent = cfg.name||'Salon Pro';
  byId('brandSub').textContent  = cfg.sub || 'Agenda & Facturaci√≥n';
  byId('footerName').textContent= cfg.name||'Salon Pro';
  byId('year').textContent = new Date().getFullYear();
  document.documentElement.style.setProperty('--primary', cfg.primary||'#6ee7b7');
  document.documentElement.style.setProperty('--accent',  cfg.accent ||'#93c5fd');
  document.documentElement.style.setProperty('--bg-opacity', cfg.bgOpacity ?? 1);
  if(cfg.bg){
    document.body.style.setProperty('--bg-image', `url('${cfg.bg}')`);
  }else{
    document.body.style.removeProperty('--bg-image');
  }
  const logoTargets=['brandLogo','loginLogo','cfg_logo_prev'];
  logoTargets.forEach(id=>{
    const el=byId(id); if(!el) return;
    if(cfg.logo){ el.src = cfg.logo; } else { el.removeAttribute('src'); }
  });
}

/* ============================================================
  NAVEGACI√ìN / SHOW por rol
  ============================================================= */
function show(id){
  $$('.screen').forEach(s=>s.classList.remove('active'));
  byId(id).classList.add('active');
  const ses = load(K.SESSION);
  const adminOnly = ['screen-export','screen-analytics','screen-empleados','screen-config'];
  adminOnly.forEach(h=>{
    const el=byId(h); if(!el) return;
    if(ses?.role==='usuario') el.classList.add('hidden'); else el.classList.remove('hidden');
  });
}

/* ============================================================
  LOGIN + Sesi√≥n expirable (12h)
  ============================================================= */
function loginEnsureUsers(){
  let users = load(K.USERS, null);
  if(!Array.isArray(users) || users.length===0){
    users = [
      {user:'admin',   pass:'admin123', role:'admin'},
      {user:'usuario', pass:'user123',  role:'usuario'}
    ];
    save(K.USERS, users);
  }
}
function login(user, pass){
  loginEnsureUsers();
  const users=load(K.USERS,[]);
  const u=users.find(x=>x.user===user && x.pass===pass);
  if(!u) return false;
  save(K.SESSION,{user:u.user, role:u.role, ts:Date.now()});
  const av=byId('whoami'); if(av) av.title=`${u.user} (${u.role})`;
  return true;
}
function isSessionValid(){
  const s = load(K.SESSION,null);
  return s && (Date.now() - s.ts) < 12*60*60*1000; // 12h
}
function logout(){
  localStorage.removeItem(K.SESSION);
  show('screen-login');
}

/* ============================================================
  EMPLEADOS
  ============================================================= */
function renderEmpleadosSelects(){
  const emps=load(K.EMP,[]);
  const onlyActive = e => (e.activo === undefined ? true : +e.activo === 1);
  const nameOf = e => e?.nombre || e?.name || '(sin nombre)';

  const targets = ['a_emp','ff_emp','h_emp','ex_emp','adm_emp'];
  targets.forEach(id=>{
    const el=byId(id); if(!el) return;
    const placeholder = (id==='a_emp'||id==='ff_emp') ? 'Seleccione' : '';
    const visibles = emps.filter(onlyActive);
    el.innerHTML = `<option value="">${placeholder}</option>` +
      visibles.map(e=>`<option value="${e.id}">${nameOf(e)}</option>`).join('');
  });

  const firstActivo = emps.find(onlyActive);
  if(byId('a_emp') && firstActivo) byId('a_emp').value = firstActivo.id;
  if(byId('ff_emp') && firstActivo) byId('ff_emp').value = firstActivo.id;
}
function renderEmpleadosTabla(){
  const tb=byId('tblEmpleados').querySelector('tbody');
  const emps=load(K.EMP,[]);
  tb.innerHTML = emps.map(e=>`
    <tr class="tr">
      <td>${e.nombre}</td>
      <td>${e.tel||''}</td>
      <td>${+e.activo?'<span class="badge">Activo</span>':'<span class="badge" style="color:#ffb; border-color:#665">Inactivo</span>'}</td>
      <td class="no-print">
        <button class="btn-ghost" onclick="empEdit('${e.id}')">Editar</button>
        <button class="btn-danger" onclick="empDel('${e.id}')">Borrar</button>
      </td>
    </tr>`).join('');
}
function empEdit(id){
  const e=load(K.EMP,[]).find(x=>x.id===id); if(!e) return;
  byId('e_nombre').value=e.nombre;
  byId('e_tel').value=e.tel||'';
  byId('e_activo').value=e.activo?'1':'0';
  byId('btnEmpGuardar').dataset.id = id;
}
function empDel(id){
  save(K.EMP, load(K.EMP,[]).filter(x=>x.id!==id));
  renderEmpleadosTabla(); renderEmpleadosSelects();
}
function empSave(){
  const nombre=byId('e_nombre').value.trim();
  const tel=byId('e_tel').value.trim();
  const activo=+byId('e_activo').value;
  if(!nombre) return alert('Nombre requerido');
  let emps=load(K.EMP,[]);
  const idEdit = byId('btnEmpGuardar').dataset.id;
  if(idEdit){
    emps=emps.map(e=> e.id===idEdit ? {...e, nombre, tel, activo} : e);
    delete byId('btnEmpGuardar').dataset.id;
  }else{
    emps.push({id:uuid(), nombre, tel, activo});
  }
  save(K.EMP, emps);
  byId('e_nombre').value=''; byId('e_tel').value=''; byId('e_activo').value='1';
  renderEmpleadosTabla(); renderEmpleadosSelects();
}

/* ============================================================
  AGENDA (no duplicar, no show, WhatsApp, Google Form)
  ============================================================= */
function citaKey(c){ return [c.fecha,c.hora,c.emp,(c.tel||'').replace(/\D/g,'')].join('|').toLowerCase(); }
function citaDuplicada(cita, citas){
  return citas.some(x=>citaKey(x)===citaKey(cita));
}
function citaGuardar(){
  const nombre=byId('a_nombre').value.trim();
  const tel=byId('a_tel').value.trim();
  const emp=byId('a_emp').value;
  const srv=byId('a_srv').value.trim();
  const fecha=byId('a_fecha').value;
  const hora=byId('a_hora').value;
  const dur=+byId('a_dur').value||60;
  const notas=byId('a_notas').value.trim();
  if(!nombre || !tel || !emp || !fecha || !hora) return alert('Completa nombre, tel√©fono, empleado, fecha y hora.');
  let citas=load(K.CITAS,[]);
  const cita={id:uuid(), nombre,tel,emp,srv,fecha,hora,dur,notas, estado:'programada'};
  if(citaDuplicada(cita,citas)) return alert('Duplicado: ya existe cita con esa persona a esa hora.');
  citas.push(cita); save(K.CITAS,citas);
  // Refresco autom√°tico
  renderCitas();
  analyticsKPIs();
  admRenderConfirmaciones();
  alert('Cita guardada.');
}
function citaNoShow(){
  const nombre=byId('a_nombre').value.trim();
  const tel=byId('a_tel').value.trim();
  const fecha=byId('a_fecha').value;
  const hora=byId('a_hora').value;
  let citas=load(K.CITAS,[]);
  citas=citas.map(c=>{
    if(c.nombre===nombre && c.tel===tel && c.fecha===fecha && c.hora===hora){ return {...c, estado:'no-show'}; }
    return c;
  });
  save(K.CITAS,citas); renderCitas(); analyticsKPIs(); alert('Marcado como No Show (si coincid√≠a).');
}
function renderCitas(filter=true){
  const tb=byId('tblCitas').querySelector('tbody');
  const emps=load(K.EMP,[]);
  const empName = id => (emps.find(e=>e.id===id)||{}).nombre||'‚Äî';
  let citas=load(K.CITAS,[]);
  if(filter){
    const fFecha=byId('f_fecha').value;
    const fEmp=byId('f_emp').value;
    if(fFecha) citas=citas.filter(c=>c.fecha===fFecha);
    if(fEmp) citas=citas.filter(c=>c.emp===fEmp);
  }
  citas.sort((a,b)=> (a.fecha+a.hora).localeCompare(b.fecha+b.hora));
  tb.innerHTML = citas.map(c=>`
    <tr class="tr">
      <td>${c.fecha}</td>
      <td>${c.hora}</td>
      <td>${c.nombre}</td>
      <td>${empName(c.emp)}</td>
      <td>${c.srv||''}</td>
      <td>${c.tel}</td>
      <td>${c.estado}</td>
      <td class="no-print">
        <button class="btn-ghost" onclick="citaWhatsApp('${c.id}')">WA</button>
        <button class="btn-ghost" onclick="citaEditar('${c.id}')">Editar</button>
        <button class="btn-danger" onclick="citaBorrar('${c.id}')">Borrar</button>
      </td>
    </tr>`).join('');
}
function citaEditar(id){
  const c=load(K.CITAS,[]).find(x=>x.id===id); if(!c) return;
  byId('a_nombre').value=c.nombre;
  byId('a_tel').value=c.tel;
  byId('a_emp').value=c.emp;
  byId('a_srv').value=c.srv||'';
  byId('a_fecha').value=c.fecha;
  byId('a_hora').value=c.hora;
  byId('a_dur').value=c.dur||60;
  byId('a_notas').value=c.notas||'';
}
function citaBorrar(id){
  save(K.CITAS, load(K.CITAS,[]).filter(x=>x.id!==id));
  renderCitas(); analyticsKPIs(); admRenderConfirmaciones();
}
function citaWhatsApp(id){
  const cfg=load(K.CFG,{});
  const c=load(K.CITAS,[]).find(x=>x.id===id); if(!c) return;
  const emps=load(K.EMP,[]); const empName=(emps.find(e=>e.id===c.emp)||{}).nombre||'';
  const fechaTxt=new Date(c.fecha+'T'+(c.hora||'00:00')).toLocaleString('es-PR');
  const msg = encodeURIComponent(
    `Hola ${c.nombre}, confirmaci√≥n de su cita:\n`+
    `üóì ${fechaTxt}\nüë§ T√©cnica: ${empName}\nüíà Servicio: ${c.srv||'-'}\n`+
    `${c.notas? 'üìù Notas: '+c.notas+'\n':''}`+
    `${cfg.maps? 'üìç Ubicaci√≥n: '+cfg.maps+'\n':''}`+
    `Responda este mensaje para confirmar. ¬°Gracias!`
  );
  const phone = (c.tel || cfg.waPhone || '').replace(/\D/g,'');
  window.open(`https://wa.me/${phone}?text=${msg}`,'_blank');
}

/* ============================================================
  FACTURACI√ìN (l√≠neas, totales, exportar, WhatsApp)
  ============================================================= */
function nextFacturaNumber(){
  let n=load(K.COUNTER_F,1001); save(K.COUNTER_F, n+1); return n;
}
function lineaTpl(id,data={}){
  return `
  <div class="row cols-4 tr" style="padding:.6rem; margin:.4rem 0">
    <div><label>Descripci√≥n</label><input data-id="${id}" data-k="desc" class="input" placeholder="Servicio o producto" value="${data.desc||''}"></div>
    <div><label>Cant.</label><input data-id="${id}" data-k="cant" type="number" min="1" step="1" class="input" value="${data.cant||1}"></div>
    <div><label>Precio</label><input data-id="${id}" data-k="precio" type="number" step=".01" class="input" value="${data.precio||0}"></div>
    <div style="display:flex; align-items:flex-end; gap:.5rem">
      <input data-id="${id}" data-k="total" class="input" disabled value="${fmtMoney((data.cant||1)*(data.precio||0))}">
      <button class="btn-danger" onclick="lineaDel('${id}')">X</button>
    </div>
  </div>`;
}
function recalcFactura(){
  const rows=[...$$('#lineas [data-k="cant"]')].map(el=>{
    const id=el.dataset.id;
    const cant=+el.value||0;
    const precio=+byId('lineas').querySelector(`[data-id="${id}"][data-k="precio"]`).value||0;
    const tot=cant*precio;
    byId('lineas').querySelector(`[data-id="${id}"][data-k="total"]`).value=fmtMoney(tot);
    return tot;
  });
  const sub = rows.reduce((a,b)=>a+b,0);
  const ivu = sub*(+byId('f_ivu').value/100);
  const tot = sub+ivu;
  byId('f_sub').value=fmtMoney(sub);
  byId('f_tax').value=fmtMoney(ivu);
  byId('f_total').value=fmtMoney(tot);
  byId('ath_monto').value=fmtMoney(tot);
}
function lineaAdd(data={}){
  const id=uuid();
  byId('lineas').insertAdjacentHTML('beforeend', lineaTpl(id,data));
  ['cant','precio'].forEach(k=>{
    byId('lineas').querySelector(`[data-id="${id}"][data-k="${k}"]`).addEventListener('input', recalcFactura);
  });
  recalcFactura();
}
function lineaDel(id){
  const node=[...byId('lineas').children].find(div=>div.querySelector(`[data-id="${id}"]`));
  if(node) node.remove(); recalcFactura();
}
function facturaNueva(){
  byId('f_num').value = nextFacturaNumber();
  byId('f_cli').value='';
  byId('f_tel').value='';
  const emps=load(K.EMP,[]);
  const firstActivo = emps.find(e => (e.activo === undefined ? true : +e.activo === 1));
  if(byId('ff_emp')) byId('ff_emp').value = (firstActivo||{}).id || '';
  byId('f_fecha').value = todayISO();
  byId('f_propina').value = 0;
  byId('f_pago').value='ATH M√≥vil';
  byId('lineas').innerHTML='';
  recalcFactura();
}
function facturaGuardar(){
  const num   = byId('f_num').value || nextFacturaNumber();
  const cli   = byId('f_cli').value.trim();
  const tel   = byId('f_tel').value.trim();
  const emp   = byId('ff_emp').value;
  const fecha = byId('f_fecha').value;
  const pago  = byId('f_pago').value;
  const ivu   = +byId('f_ivu').value;
  const prop  = +(byId('f_propina').value||0) || 0;

  const items = [...$$('#lineas [data-k="desc"]')].map(el=>{
    const id=el.dataset.id;
    const cant  = +byId('lineas').querySelector(`[data-id="${id}"][data-k="cant"]`).value||0;
    const precio= +byId('lineas').querySelector(`[data-id="${id}"][data-k="precio"]`).value||0;
    return {desc:el.value, cant, precio};
  });
  if(!cli || !fecha || items.length===0) return alert('Cliente, fecha y al menos una l√≠nea.');

  const sub=items.reduce((a,i)=>a+i.cant*i.precio,0);
  const tax=sub*(ivu/100);
  const tot=sub+tax; // Propina aparte

  let facts=load(K.FACTS,[]);
  const exists=facts.find(x=>x.num==num);

  const data={
    id:exists?.id||uuid(), num, cli, tel, emp, fecha, pago, ivu,
    propina: prop, // ‚Üê guardar propina limpio
    // 'notas' solo si exist√≠a antes, para no romper legados:
    notas: exists ? (exists.notas ?? '') : '',
    items, sub, tax, tot
  };

  facts = exists ? facts.map(x=> x.num==num? data : x) : [...facts, data];
  save(K.FACTS,facts);

  // Refresco autom√°tico
  renderFacturas();
  analyticsKPIs();
  analyticsChart30();
  alert('Factura guardada.');

  // Preparar siguiente factura
  facturaNueva();
}
function renderFacturas(){
  const tb=byId('tblFacturas').querySelector('tbody');
  let facts=load(K.FACTS,[]);
  const d=byId('h_desde').value, h=byId('h_hasta').value, e=byId('h_emp').value;
  if(d) facts=facts.filter(f=>f.fecha>=d);
  if(h) facts=facts.filter(f=>f.fecha<=h);
  if(e) facts=facts.filter(f=>f.emp===e);
  facts.sort((a,b)=> (b.fecha+a.num).localeCompare(a.fecha+b.num));
  const emps=load(K.EMP,[]); const empName=id=>(emps.find(x=>x.id===id)||{}).nombre||'';
  tb.innerHTML=facts.map(f=>`
    <tr class="tr">
      <td>${f.num}</td><td>${f.fecha}</td><td>${f.cli}</td><td>${empName(f.emp)}</td>
      <td>${f.pago}</td><td>${fmtMoney(f.tot)}</td>
      <td class="no-print">
        <button class="btn-ghost" onclick="factImprimir(${f.num})">PDF</button>
        <button class="btn-ghost" onclick="factCSV(${f.num})">CSV</button>
        <button class="btn-ghost" onclick="factWA(${f.num})">WA</button>
        <button class="btn-danger" onclick="factDel(${f.num})">X</button>
      </td>
    </tr>`).join('');
}
function factData(num){ return load(K.FACTS,[]).find(f=>f.num==num); }
function factDel(num){ save(K.FACTS, load(K.FACTS,[]).filter(f=>f.num!=num)); renderFacturas(); analyticsKPIs(); analyticsChart30(); }
function factWA(num){
  const cfg = load(K.CFG,{});
  const f = factData(num);
  if(!f) return;
  const emps = load(K.EMP,[]);
  const emp  = emps.find(e => e.id === f.emp) || {};
  const phone = (emp.tel || cfg.waPhone || '').replace(/\D/g,'');
  const prop = Number.isFinite(f.propina) ? f.propina : (+(f.notas||0) || 0); // lee legado

  const msg = encodeURIComponent(
    `${cfg.waFacto || 'Gracias por su visita. Detalle:'}\n`+
    `Factura #${f.num}\n`+
    `Fecha: ${f.fecha}\n`+
    `T√©cnica: ${emp.nombre || ''}\n`+
    `Total: ${fmtMoney(f.tot)}\n`+
    (prop>0 ? `Propina: ${fmtMoney(prop)}\n` : '')+
    (cfg.maps ? `Ubicaci√≥n: ${cfg.maps}\n` : '')+
    `Detalle:\n` + f.items.map(i =>
      `‚Ä¢ ${i.desc} x${i.cant} = ${fmtMoney(i.cant*i.precio)}`
    ).join('\n')
  );

  if(phone){
    window.open(`https://wa.me/${phone}?text=${msg}`, '_blank');
  } else {
    alert("No se encontr√≥ n√∫mero de tel√©fono para la t√©cnica.");
  }
}

/* ============================================================
  EXPORTACIONES (rango, preview, CSV, Print con propinas por t√©cnica)
  ============================================================= */
function rango(periodo, base){
  const d=new Date(base||todayISO());
  let ini=new Date(d), fin=new Date(d);
  if(periodo==='dia'){ /* mismo d√≠a */ }
  if(periodo==='semana'){
    const day=d.getDay();
    ini.setDate(d.getDate()-(day||7)+1); fin=new Date(ini); fin.setDate(ini.getDate()+6);
  }
  if(periodo==='mes'){
    ini=new Date(d.getFullYear(), d.getMonth(), 1);
    fin=new Date(d.getFullYear(), d.getMonth()+1, 0);
  }
  if(periodo==='anio'){
    ini=new Date(d.getFullYear(),0,1); fin=new Date(d.getFullYear(),11,31);
  }
  const toISO=x=>x.toISOString().slice(0,10);
  return {desde:toISO(ini), hasta:toISO(fin)};
}
function exportPreview(){
  const tipo=byId('ex_tipo').value;
  const emp=byId('ex_emp').value;
  const per=byId('ex_periodo').value;
  let {desde,hasta} = per==='rango'
    ? {desde:byId('ex_desde').value, hasta:byId('ex_hasta').value}
    : rango(per, byId('ex_fecha').value||todayISO());

  if(!desde||!hasta) { const r=rango('dia', todayISO()); desde=r.desde; hasta=r.hasta; }

  const emps=load(K.EMP,[]);
  const empName = id => (emps.find(x=>x.id===id)||{}).nombre || '';

  let head=[], rows=[];
  if(tipo==='facturas'){
    let facts=load(K.FACTS,[]).filter(f=>f.fecha>=desde && f.fecha<=hasta);
    if(emp) facts=facts.filter(f=>f.emp===emp);
    head=['#','Fecha','Cliente','Empleado','M√©todo','Subtotal','IVU','Total','Propina'];
    rows=facts.map(f=>{
      const totalSinProp = (Number(f.sub)||0) + (Number(f.tax)||0);
      const prop = Number.isFinite(f.propina) ? Number(f.propina) : (+(f.notas||0) || 0);
      return [
        f.num, f.fecha, f.cli, empName(f.emp), f.pago,
        (Number(f.sub)||0).toFixed(2),
        (Number(f.tax)||0).toFixed(2),
        totalSinProp.toFixed(2),
        prop.toFixed(2)
      ];
    });
  }else{
    let citas=load(K.CITAS,[]).filter(c=>c.fecha>=desde && c.fecha<=hasta);
    if(emp) citas=citas.filter(c=>c.emp===emp);
    head=['Fecha','Hora','Cliente','Empleado','Servicio','Tel','Estado'];
    rows=citas.map(c=>[
      c.fecha, c.hora, c.nombre, empName(c.emp), c.srv||'', c.tel, c.estado
    ]);
  }

  byId('exHead').innerHTML = head.map(h=>`<th>${h}</th>`).join('');
  byId('exBody').innerHTML = rows
    .map(r=>`<tr class="tr">${r.map(c=>`<td>${c}</td>`).join('')}</tr>`)
    .join('');

  return {head, rows, desde, hasta, tipo, emp, empName};
}
function exportCSV(){
  const {head, rows, desde, hasta, tipo}=exportPreview();
  let csv=head.map(csvSafe).join(',')+'\n';
  rows.forEach(r=> csv+=r.map(csvSafe).join(',')+'\n');
  const suf = tipo==='facturas'?'FACTURAS':'CITAS';
  download(`${suf}_${desde}_a_${hasta}.csv`, csv, 'text/csv');
}
function exportPrint(){
  const {head, rows, desde, hasta, tipo, emp, empName}=exportPreview();

  // Totales del periodo (solo para FACTURAS)
  let propinasHTML = '';
  let totalesHTML  = '';
  if (tipo === 'facturas') {
    const facts = load(K.FACTS,[])
      .filter(f => f.fecha >= desde && f.fecha <= hasta && (!emp || f.emp === emp));

    // Totales contables del periodo (sin propina)
    const tSub = facts.reduce((a,f)=> a + (Number(f.sub)||0), 0);
    const tIvu = facts.reduce((a,f)=> a + (Number(f.tax)||0), 0);
    const tTot = facts.reduce((a,f)=> a + ((Number(f.sub)||0) + (Number(f.tax)||0)), 0);

    // Totales de propinas por t√©cnica (aparte)
    const byTec = {};
    facts.forEach(f=>{
      const tec = empName(f.emp) || '(Sin t√©cnica)';
      const p = Number.isFinite(f.propina) ? f.propina : (+(f.notas||0) || 0);
      byTec[tec] = (byTec[tec]||0) + p;
    });
    const totalProp = Object.values(byTec).reduce((a,b)=>a+b,0);

    totalesHTML = `
      <h3 style="margin-top:14px">Totales del per√≠odo (facturaci√≥n)</h3>
      <table style="width:100%; border-collapse:collapse; margin-top:6px">
        <tbody>
          <tr>
            <td style="border:1px solid #ddd; padding:6px; font-weight:700">Subtotal</td>
            <td style="border:1px solid #ddd; padding:6px; text-align:right; font-weight:700">${fmtMoney(tSub)}</td>
          </tr>
          <tr>
            <td style="border:1px solid #ddd; padding:6px; font-weight:700">IVU</td>
            <td style="border:1px solid #ddd; padding:6px; text-align:right; font-weight:700">${fmtMoney(tIvu)}</td>
          </tr>
          <tr>
            <td style="border:1px solid #ddd; padding:6px; font-weight:800">Total facturaci√≥n</td>
            <td style="border:1px solid #ddd; padding:6px; text-align:right; font-weight:800">${fmtMoney(tTot)}</td>
          </tr>
        </tbody>
      </table>`;

    propinasHTML = `
      <h3 style="margin-top:14px">Propinas (aparte, por t√©cnica)</h3>
      <table style="width:100%; border-collapse:collapse; margin-top:6px">
        <thead><tr>
          <th style="border:1px solid #ddd; padding:6px; text-align:left">T√©cnica</th>
          <th style="border:1px solid #ddd; padding:6px; text-align:right">Total Propinas</th>
        </tr></thead>
        <tbody>
          ${Object.entries(byTec).map(([k,v])=>`
            <tr>
              <td style="border:1px solid #ddd; padding:6px">${k}</td>
              <td style="border:1px solid #ddd; padding:6px; text-align:right">${fmtMoney(v)}</td>
            </tr>`).join('')}
          <tr>
            <td style="border:1px solid #ddd; padding:6px; font-weight:700">Total periodo</td>
            <td style="border:1px solid #ddd; padding:6px; text-align:right; font-weight:700">${fmtMoney(totalProp)}</td>
          </tr>
        </tbody>
      </table>`;
  }

  const html=`
  <html><head><meta charset="utf-8"><title>Exportaci√≥n</title>
  <style>
    body{font-family:${getComputedStyle(document.documentElement).getPropertyValue('--font')}; padding:20px}
    table{width:100%; border-collapse:collapse; margin-top:10px}
    th,td{border:1px solid #ddd; padding:6px}
    h2,h3{margin:0}
  </style>
  </head><body>
    <h2>Panel Administrativo ‚Äî ${tipo.toUpperCase()}</h2>
    <h3>${desde} a ${hasta}${emp? ' ‚Äî T√©cnica: '+empName(emp):''}</h3>
    <table><thead><tr>${head.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
    <tbody>${rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}</tbody></table>
    ${totalesHTML}
    ${propinasHTML}
  </body></html>`;
  const w=window.open('','_blank'); w.document.write(html); w.document.close(); w.focus(); w.print();
}

/* ============================================================
  ANALYTICS (KPIs + chart 30 d√≠as)
  ============================================================= */
function analyticsKPIs(){
  const facts=load(K.FACTS,[]);
  const citas=load(K.CITAS,[]);
  const hoy=todayISO(); const ym=hoy.slice(0,7);
  const suma = arr => arr.reduce((a,b)=>a+b,0);
  const ingresosHoy = suma(facts.filter(f=>f.fecha===hoy).map(f=>f.tot));
  const ingresosMes = suma(facts.filter(f=>f.fecha.startsWith(ym)).map(f=>f.tot));
  const citasHoy = citas.filter(c=>c.fecha===hoy).length;
  const noshowMes = citas.filter(c=>c.fecha.startsWith(ym) && c.estado==='no-show').length;
  byId('kpi_ingresos_hoy').textContent = fmtMoney(ingresosHoy);
  byId('kpi_ingresos_mes').textContent = fmtMoney(ingresosMes);
  byId('kpi_citas_hoy').textContent = citasHoy;
  byId('kpi_noshow_mes').textContent = noshowMes;
}
function analyticsChart30(){
  const facts=load(K.FACTS,[]);
  const days=[];
  for(let i=29;i>=0;i--){
    const d=new Date(); d.setDate(d.getDate()-i);
    const iso=d.toISOString().slice(0,10);
    const total=facts.filter(f=>f.fecha===iso).reduce((a,b)=>a+b.tot,0);
    days.push({d,iso,total});
  }
  const cvs=byId('chart30'), ctx=cvs.getContext('2d');
  const W=cvs.width = cvs.clientWidth || 800, H=cvs.height;
  ctx.clearRect(0,0,W,H);
  const pad=30; const max=Math.max(1,...days.map(x=>x.total));
  ctx.strokeStyle='#cdd4ff'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(pad,10); ctx.lineTo(pad,H-pad); ctx.lineTo(W-10,H-pad); ctx.stroke();
  ctx.fillStyle='#9aa3c7'; ctx.font='12px sans-serif';
  for(let i=0;i<=4;i++){
    const val=max*i/4; const y=H-pad-(H-2*pad)*(val/max);
    ctx.fillText(fmtMoney(val).replace('$',''), 4, y+4);
    ctx.strokeStyle='rgba(205,212,255,.15)';
    ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-10,y); ctx.stroke();
  }
  const dx=(W-2*pad)/(days.length-1);
  ctx.beginPath();
  days.forEach((p,idx)=>{
    const x=pad+dx*idx;
    const y=H-pad-(H-2*pad)*(p.total/max);
    if(idx===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.strokeStyle='#93c5fd'; ctx.lineWidth=2; ctx.stroke();
}

/* ============================================================
  GOOGLE FORM
  ============================================================= */
function toMMDDYYYY(iso){
  if(!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return iso;
  const [y,m,d] = iso.split('-'); return `${m}/${d}/${y}`;
}
async function citaGoogle(){
  const cfg=load(K.CFG,{});
  if(!cfg.formUrl){ alert('Configura la URL de formResponse en Configuraci√≥n.'); return; }
  const m=cfg.formMap||{};
  const nombre=byId('a_nombre').value.trim();
  const tel=byId('a_tel').value.trim();
  const emp=byId('a_emp').value;
  const srv=byId('a_srv').value.trim();
  const fechaISO=byId('a_fecha').value;
  const hora24=byId('a_hora').value;
  if(!nombre||!tel||!emp||!fechaISO||!hora24){ alert('Completa nombre, tel√©fono, empleado, fecha y hora.'); return; }
  const emps=load(K.EMP,[]); const empName=(emps.find(e=>e.id===emp)||{}).nombre||'';
  const fechaForm = toMMDDYYYY(fechaISO);
  const payload = new URLSearchParams({
    [m.nombre]:   nombre,
    [m.tel]:      tel,
    [m.fecha]:    fechaForm,
    [m.hora]:     hora24,
    [m.servicio]: srv,
    [m.tecnica]:  empName,
    [m.correo]:   "",
    'fvv': '1',
    'submit': 'Submit'
  });
  try{
    const url = cfg.formUrl.endsWith('/formResponse') ? cfg.formUrl : cfg.formUrl.replace('/viewform','/formResponse');
    await fetch(url,{method:'POST', body:payload, mode:'no-cors'});
    alert('Cita enviada a Google Form. Verifica tu Sheet.');
  }catch(e){ console.error(e); alert('Error enviando al Form.'); }
}
function citaGoogleTestOpen(){
  const cfg=load(K.CFG,{});
  if(!cfg.formUrl){ return alert('Configura la URL de formResponse.'); }
  const m=cfg.formMap||{};
  const nombre=byId('a_nombre').value.trim()||'Prueba Nombre';
  const tel=byId('a_tel').value.trim()||'7870000000';
  const emp=byId('a_emp').value;
  const srv=byId('a_srv').value.trim()||'Servicio Prueba';
  const fechaISO=byId('a_fecha').value||todayISO();
  const hora24=byId('a_hora').value||'08:00';
  const emps=load(K.EMP,[]); const empName=(emps.find(e=>e.id===emp)||{}).nombre||'T√©cnica';
  const fechaForm = toMMDDYYYY(fechaISO);
  const qp = new URLSearchParams({
    [m.nombre]:   nombre,
    [m.tel]:      tel,
    [m.fecha]:    fechaForm,
    [m.hora]:     hora24,
    [m.servicio]: srv,
    [m.tecnica]:  empName,
    [m.correo]:   "",
    'fvv':'1','submit':'Submit'
  });
  const viewUrl = cfg.formUrl.includes('/viewform') ? cfg.formUrl : cfg.formUrl.replace('/formResponse','/viewform');
  const testUrl = (viewUrl.endsWith('/viewform') ? viewUrl : viewUrl.split('?')[0]) + '?' + qp.toString();
  window.open(testUrl,'_blank');
}

/* ============================================================
  SERVICIOS
  ============================================================= */
function renderServicios(){
  const tb=byId('tblServicios').querySelector('tbody');
  const sv=load(K.SVC,[]);
  tb.innerHTML = sv.map(s=>`
    <tr class="tr">
      <td>${s.nombre}</td>
      <td>${fmtMoney(s.precio)}</td>
      <td class="no-print">
        <button class="btn-ghost" onclick="svUse('${s.id}')">Usar en factura</button>
        <button class="btn-ghost" onclick="svEdit('${s.id}')">Editar</button>
        <button class="btn-danger" onclick="svDel('${s.id}')">Borrar</button>
      </td>
    </tr>`).join('');
}
function svAdd(){
  const nombre=byId('sv_nombre').value.trim();
  const precio=+byId('sv_precio').value||0;
  if(!nombre) return alert('Nombre requerido');
  const sv=load(K.SVC,[]); sv.push({id:uuid(), nombre, precio}); save(K.SVC,sv);
  byId('sv_nombre').value=''; byId('sv_precio').value='';
  renderServicios();
}
function svUse(id){
  const s=load(K.SVC,[]).find(x=>x.id===id); if(!s) return;
  lineaAdd({desc:s.nombre, cant:1, precio:s.precio});
}
function svEdit(id){
  const s=load(K.SVC,[]).find(x=>x.id===id); if(!s) return;
  byId('sv_nombre').value=s.nombre; byId('sv_precio').value=s.precio;
  byId('btnSvAgregar').dataset.id=id;
}
function svDel(id){
  save(K.SVC, load(K.SVC,[]).filter(x=>x.id!==id)); renderServicios();
}

/* ============================================================
  CONFIG: cargar/guardar + export/import + Aplicar cambios
  ============================================================= */
function cfgLoadInputs(){
  const c=load(K.CFG,{});
  byId('cfg_name').value=c.name||'';
  byId('cfg_sub').value=c.sub||'';
  byId('cfg_bg_op').value=c.bgOpacity??1;
  byId('cfg_primary').value=c.primary||'#6ee7b7';
  byId('cfg_accent').value=c.accent||'#93c5fd';
  byId('cfg_form_url').value=c.formUrl||'';
  byId('cfg_script_url').value=c.scriptUrl||'';
  byId('cfg_wa_phone').value=c.waPhone||'';
  byId('cfg_wa_fact').value=c.waFacto||'';
  byId('cfg_maps').value=c.maps||'';
  if(c.logo) byId('cfg_logo_prev').src=c.logo;
}
function cfgSave(partial){
  const c={...load(K.CFG,{}), ...partial};
  save(K.CFG,c); applyBrand();
}
function fileToDataURL(file){
  return new Promise(res=>{
    const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file);
  });
}
async function onLogoChange(e){
  const f=e.target.files?.[0]; if(!f) return;
  const data=await fileToDataURL(f);
  byId('cfg_logo_prev').src=data;
  cfgSave({logo:data});
}
async function onBgChange(e){
  const f=e.target.files?.[0]; if(!f) return;
  const data=await fileToDataURL(f);
  cfgSave({bg:data});
}
function exportConfig(){
  const dump={
    config:load(K.CFG,{}),
    empleados:load(K.EMP,[]),
    servicios:load(K.SVC,[]),
    citas:load(K.CITAS,[]),
    facturas:load(K.FACTS,[]),
    users:load(K.USERS,[])
  };
  download(`salonpro_config_${Date.now()}.json`, JSON.stringify(dump,null,2),'application/json');
}
function importConfig(file){
  const r=new FileReader();
  r.onload=()=>{
    try{
      const j=JSON.parse(r.result);
      if(j.config) save(K.CFG,j.config);
      if(j.empleados) save(K.EMP,j.empleados);
      if(j.servicios) save(K.SVC,j.servicios);
      if(j.citas) save(K.CITAS,j.citas);
      if(j.facturas) save(K.FACTS,j.facturas);
      if(j.users) save(K.USERS,j.users);
      applyBrand(); renderEmpleadosSelects(); renderEmpleadosTabla(); renderServicios(); renderCitas(); renderFacturas();
      analyticsKPIs(); analyticsChart30(); admRenderConfirmaciones();
      alert('Configuraci√≥n importada.');
    }catch(e){ alert('Archivo inv√°lido.'); }
  };
  r.readAsText(file);
}
function cfgCollectFromInputs(){
  return {
    name: byId('cfg_name').value,
    sub:  byId('cfg_sub').value,
    bgOpacity: +byId('cfg_bg_op').value || 1,
    primary: byId('cfg_primary').value,
    accent:  byId('cfg_accent').value,
    formUrl: byId('cfg_form_url').value,
    scriptUrl: byId('cfg_script_url').value,
    waPhone: byId('cfg_wa_phone').value,
    waFacto: byId('cfg_wa_fact').value,
    maps:    byId('cfg_maps').value,
  };
}
function cfgAplicar(){
  const partial = cfgCollectFromInputs();
  cfgSave(partial);
  renderEmpleadosSelects();
  alert('Cambios aplicados y guardados.');
}

/* ============================================================
  PANEL ADMINISTRATIVO ‚Äî Confirmaci√≥n 24h
  ============================================================= */
function tomorrowISO(base){
  const d = base ? new Date(base) : new Date();
  d.setDate(d.getDate()+1);
  return d.toISOString().slice(0,10);
}
function admRenderConfirmaciones(){
  const base = byId('adm_base').value || todayISO();
  const target = tomorrowISO(base);
  const empSel = byId('adm_emp').value;
  const emps=load(K.EMP,[]); const empName=id=>(emps.find(e=>e.id===id)||{}).nombre||'';
  let citas = load(K.CITAS,[]).filter(c=>c.fecha===target);
  if(empSel) citas=citas.filter(c=>c.emp===empSel);
  citas.sort((a,b)=> (a.hora+a.nombre).localeCompare(b.hora+b.nombre));
  const tb = byId('adm_tbl');
  tb.innerHTML = citas.map(c=>{
    const fechaTxt=new Date(c.fecha+'T'+(c.hora||'00:00')).toLocaleString('es-PR');
    return `<tr class="tr">
      <td>${c.fecha}</td><td>${c.hora}</td>
      <td>${c.nombre}</td><td>${empName(c.emp)}</td><td>${c.srv||''}</td><td>${c.tel}</td>
      <td class="no-print"><button class="btn-ghost" data-wa="${c.id}">WhatsApp</button></td>
    </tr>`;
  }).join('');
  // listeners WA
  tb.querySelectorAll('[data-wa]').forEach(b=>{
    b.addEventListener('click', ()=>citaWhatsApp(b.getAttribute('data-wa')));
  });
}
// Enviar WA masivo como lista de enlaces (evita bloqueos de popups)
function admWhatsAll(){
  const ids = Array.from(byId('adm_tbl').querySelectorAll('[data-wa]')).map(b=>b.getAttribute('data-wa'));
  const cfg=load(K.CFG,{});
  const emps=load(K.EMP,[]);
  const empName=id=>(emps.find(e=>e.id===id)||{}).nombre||'';
  const links = ids.map(id=>{
    const c=load(K.CITAS,[]).find(x=>x.id===id);
    if(!c) return '';
    const fechaTxt=new Date(c.fecha+'T'+(c.hora||'00:00')).toLocaleString('es-PR');
    const msg = encodeURIComponent(`Hola ${c.nombre}, confirmaci√≥n de su cita:\nüóì ${fechaTxt}\nüë§ T√©cnica: ${empName(c.emp)}\nüíà Servicio: ${c.srv||'-'}\n${cfg.maps? 'üìç Ubicaci√≥n: '+cfg.maps+'\n':''}Responda para confirmar. ¬°Gracias!`);
    const phone = (c.tel || cfg.waPhone || '').replace(/\D/g,'');
    return `https://wa.me/${phone}?text=${msg}`;
  }).filter(Boolean);
  const w = window.open('', '_blank');
  w.document.write('<h3>WhatsApp ‚Äî Abrir manualmente</h3><ul style="font-family:sans-serif">' + links.map(u=>`<li><a href="${u}" target="_blank" rel="noopener">Abrir chat</a></li>`).join('') + '</ul>');
  w.document.close();
}

/* ============================================================
  EVENTOS UI
  ============================================================= */
function bindUI(){
  // navegaci√≥n topbar
  byId('btnHome').onclick = ()=>show('screen-home');
  byId('btnConfig').onclick=()=>show('screen-config');
  byId('btnLogout').onclick=()=>{logout();};

  // botones de tarjetas
  $$('[data-goto]').forEach(b=> b.onclick=()=> show(b.dataset.goto));

  // LOGIN
  byId('doLogin').onclick = ()=>{
    const u = byId('loginUser').value.trim();
    const p = byId('loginPass').value.trim();
    const ok = login(u, p);
    if(!ok){
      alert('Credenciales inv√°lidas. Usa admin/admin123 o usuario/user123');
      return;
    }
    show('screen-home');
  };
  ['loginUser','loginPass'].forEach(id=>{
    const el=byId(id);
    el && el.addEventListener('keydown', e=>{
      if(e.key==='Enter') byId('doLogin').click();
    });
  });

  // Normalizaci√≥n b√°sica de tel√©fonos
  ;['a_tel','f_tel','e_tel','cfg_wa_phone'].forEach(id=>{
    const el=byId(id); if(!el) return;
    el.addEventListener('input', e=>{
      e.target.value = e.target.value.replace(/[^\d+ ]/g,'');
    });
  });

  // EMPLEADOS
  byId('btnEmpGuardar')?.addEventListener('click', empSave);
  byId('btnEmpLimpiar')?.addEventListener('click', ()=>{
    byId('e_nombre').value=''; byId('e_tel').value=''; byId('e_activo').value='1';
    delete byId('btnEmpGuardar').dataset.id;
  });

  // AGENDA
  byId('btnAgendaGuardar')?.addEventListener('click', citaGuardar);
  byId('btnAgendaNoShow')?.addEventListener('click', citaNoShow);
  byId('btnAgendaFiltrar')?.addEventListener('click', ()=>renderCitas(true));
  byId('btnAgendaWhatsApp')?.addEventListener('click', ()=>{
    const temp={id:'temp', nombre:byId('a_nombre').value, tel:byId('a_tel').value, emp:byId('a_emp').value, srv:byId('a_srv').value, fecha:byId('a_fecha').value, hora:byId('a_hora').value, notas:byId('a_notas').value};
    load(K.CITAS,[]).push(temp); save(K.CITAS,load(K.CITAS,[])); citaWhatsApp('temp');
    save(K.CITAS, load(K.CITAS,[]).filter(x=>x.id!=='temp'));
  });
  byId('btnAgendaGoogle')?.addEventListener('click', citaGoogle);
  byId('btnAgendaGoogleTest')?.addEventListener('click', citaGoogleTestOpen);
  byId('btnAgendaImprimir')?.addEventListener('click', ()=>window.print());

  // FACTURACI√ìN
  byId('btnAddLinea')?.addEventListener('click', ()=>lineaAdd());
  byId('btnLoadServicios')?.addEventListener('click', ()=>renderServicios());
  byId('f_ivu')?.addEventListener('input', recalcFactura);
  byId('btnFacturaGuardar')?.addEventListener('click', facturaGuardar);
  byId('btnFacturaExportCSV')?.addEventListener('click', ()=>{ const n=byId('f_num').value; if(!n) return alert('Guarda primero.'); factCSV(n); });
  byId('btnFacturaExportPDF')?.addEventListener('click', ()=>{ const n=byId('f_num').value; if(!n) return alert('Guarda primero.'); factImprimir(n); });
  byId('btnFacturaWhatsApp')?.addEventListener('click', ()=>{ const n=byId('f_num').value; if(!n) return alert('Guarda primero.'); factWA(n); });
  byId('btnHistFiltrar')?.addEventListener('click', renderFacturas);

  // PANEL ADMINISTRATIVO (confirmaci√≥n 24h + export)
  byId('adm_base') && (byId('adm_base').value = todayISO());
  byId('adm_aplicar')?.addEventListener('click', admRenderConfirmaciones);
  byId('adm_wa_all')?.addEventListener('click', admWhatsAll);

  byId('ex_periodo')?.addEventListener('change', ()=>{
    const isR=byId('ex_periodo').value==='rango';
    byId('ex_rango_wrap').style.display=isR?'grid':'none';
  });
  byId('btnExportCSV')?.addEventListener('click', exportCSV);
  byId('btnExportPrint')?.addEventListener('click', exportPrint);

  // SERVICIOS
  byId('btnSvAgregar')?.addEventListener('click', ()=>{
    const id=byId('btnSvAgregar').dataset.id;
    if(id){
      const sv=load(K.SVC,[]).map(s=> s.id===id ? {...s, nombre:byId('sv_nombre').value.trim(), precio:+byId('sv_precio').value||0} : s);
      save(K.SVC,sv); delete byId('btnSvAgregar').dataset.id;
      byId('sv_nombre').value=''; byId('sv_precio').value='';
      renderServicios();
    }else{
      svAdd();
    }
  });

  // CONFIG (branding + integraciones + aplicar)
  byId('cfg_logo')?.addEventListener('change', onLogoChange);
  byId('cfg_bg')?.addEventListener('change', onBgChange);
  byId('cfg_name')?.addEventListener('input',  e=>cfgSave({name:e.target.value}));
  byId('cfg_sub')?.addEventListener('input',   e=>cfgSave({sub:e.target.value}));
  byId('cfg_bg_op')?.addEventListener('input', e=>cfgSave({bgOpacity:+e.target.value}));
  byId('cfg_primary')?.addEventListener('input', e=>cfgSave({primary:e.target.value}));
  byId('cfg_accent')?.addEventListener('input',  e=>cfgSave({accent:e.target.value}));
  byId('cfg_form_url')?.addEventListener('input',e=>cfgSave({formUrl:e.target.value}));
  byId('cfg_script_url')?.addEventListener('input',e=>cfgSave({scriptUrl:e.target.value}));
  byId('cfg_wa_phone')?.addEventListener('input',e=>cfgSave({waPhone:e.target.value}));
  byId('cfg_wa_fact')?.addEventListener('input', e=>cfgSave({waFacto:e.target.value}));
  byId('cfg_maps')?.addEventListener('input',    e=>cfgSave({maps:e.target.value}));
  byId('btnExportConfig')?.addEventListener('click', exportConfig);
  byId('cfgImport')?.addEventListener('change', e=>e.target.files[0] && importConfig(e.target.files[0]));
  byId('btnCfgAplicar')?.addEventListener('click', cfgAplicar);
}

/* ============================================================
  INICIO (boot)
  ============================================================= */
function boot(){
  ensureDefaults();
  applyBrand();
  renderEmpleadosTabla();
  renderEmpleadosSelects();
  renderServicios();
  byId('a_fecha').value = todayISO();
  byId('f_fecha').value = todayISO();
  renderCitas();
  renderFacturas();
  facturaNueva();
  const ses=load(K.SESSION,null);
  if(ses && isSessionValid()){ byId('whoami').title=`${ses.user} (${ses.role})`; show('screen-home'); }
  else { logout(); }
  analyticsKPIs(); analyticsChart30();
  bindUI();
  // Inicializa panel admin (confirmaci√≥n 24h preview)
  admRenderConfirmaciones();
}
window.addEventListener('DOMContentLoaded', ()=> boot());

/* ============================================================
  PLACEHOLDERS actualizados (CSV seguro + legado propina)
  ============================================================= */
function factCSV(num){
  const f=factData(num); if(!f) return alert('No existe la factura.');
  const emps=load(K.EMP,[]); const empName=id=>(emps.find(x=>x.id===id)||{}).nombre||'';
  const prop = Number.isFinite(f.propina) ? f.propina : (+(f.notas||0) || 0);
  const rows=[
    ['#','Fecha','Cliente','Empleado','M√©todo','Subtotal','IVU','Total','Propina'],
    [f.num,f.fecha,f.cli,empName(f.emp),f.pago,f.sub,f.tax,f.tot,prop]
  ];
  let csv = rows.map(r=>r.map(csvSafe).join(',')).join('\n');
  download(`factura_${f.num}.csv`, csv, 'text/csv');
}
function factImprimir(num){
  const f=factData(num); if(!f) return alert('No existe la factura.');
  const emps=load(K.EMP,[]); const empName=id=>(emps.find(x=>x.id===id)||{}).nombre||'';
  const prop = Number.isFinite(f.propina) ? f.propina : (+(f.notas||0) || 0);
  const html=`
  <html><head><meta charset="utf-8"><title>Factura ${f.num}</title>
  <style>body{font-family:system-ui; padding:20px} table{width:100%; border-collapse:collapse} th,td{border:1px solid #ddd; padding:6px}</style>
  </head><body>
    <h2>Factura #${f.num}</h2>
    <p><b>Fecha:</b> ${f.fecha} &nbsp; <b>T√©cnica:</b> ${empName(f.emp)} &nbsp; <b>M√©todo:</b> ${f.pago}</p>
    <p><b>Cliente:</b> ${f.cli} ‚Äî ${f.tel||''}</p>
    <table><thead><tr><th>Descripci√≥n</th><th>Cant</th><th>Precio</th><th>Total</th></tr></thead>
      <tbody>
        ${f.items.map(i=>`<tr><td>${i.desc}</td><td>${i.cant}</td><td>${fmtMoney(i.precio)}</td><td>${fmtMoney(i.cant*i.precio)}</td></tr>`).join('')}
      </tbody>
    </table>
    <p><b>Subtotal:</b> ${fmtMoney(f.sub)} &nbsp; <b>IVU:</b> ${fmtMoney(f.tax)} &nbsp; <b>Total:</b> ${fmtMoney(f.tot)}</p>
    <hr/>
    <p><b>Propina (aparte):</b> ${fmtMoney(prop)}</p>
  </body></html>`;
  const w=window.open('','_blank'); w.document.write(html); w.document.close(); w.focus(); w.print();
}
</script>
   <script>
/* ============================================================
   FLUJO DE CAJA (integrado en Facturaci√≥n)
   ============================================================= */
(function(){
  const CFK = {
    FACTS: 'sp_facturas',
    EMP: 'sp_empleados',
    GASTOS: 'sp_gastos',
    MOVS: 'sp_cf_movs',
    CFG: 'sp_cf_cfg'
  };

  const byId = id => document.getElementById(id);
  const load = (k,d=null)=>JSON.parse(localStorage.getItem(k)||JSON.stringify(d));
  const save = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
  const todayISO = ()=>new Date().toISOString().slice(0,10);
  const fmt = n => (Number(n||0)).toLocaleString('es-PR',{style:'currency',currency:'USD'});
  const csvSafe = v => {
    const s=String(v??''); const needs=/[",\n]/.test(s)||/^[=+\-@]/.test(s);
    return needs?`"${s.replace(/"/g,'""')}"`:s;
  };
  const toNum = v => {
    if(v===null||v===undefined) return 0;
    if(typeof v==='number') return Number.isFinite(v)?v:0;
    const s=String(v).trim(); if(!s) return 0;
    const n=parseFloat(s.replace(/[^\d,.\-]/g,'').replace(',', '.'));
    return Number.isFinite(n)?n:0;
  };

  function cf_ensureStores(){
    if(!load(CFK.GASTOS)) save(CFK.GASTOS,[]);
    if(!load(CFK.MOVS)) save(CFK.MOVS,[]);
    if(!load(CFK.CFG)) save(CFK.CFG,{propinas:0, saldo:0});
  }

  function cf_empName(id){
    const emps=load(CFK.EMP,[])||[];
    return (emps.find(e=>e.id===id)||{}).nombre||'';
  }
  function cf_fillEmps(includeAll){
    const sel=byId('cf_emp'); if(!sel) return;
    const emps=(load(CFK.EMP,[])||[]).filter(e=>(e.activo===undefined?true:+e.activo===1));
    sel.innerHTML = (includeAll?`<option value="">Todas</option>`:'') +
      emps.map(e=>`<option value="${e.id}">${e.nombre||'(Sin nombre)'}</option>`).join('');
    sel.value = includeAll? '' : (emps[0]?.id||'');
  }

  // Lee propina de facturas (campo propina o legado en notas)
  function cf_propina(f){
    if(!f) return 0;
    const keys=['propina','prop','propinas'];
    for(const k of keys){ if(f.hasOwnProperty(k)){ const n=toNum(f[k]); if(Number.isFinite(n)) return n; } }
    if(f.notas){
      const m=String(f.notas).match(/-?\d+(?:[.,]\d+)?/);
      if(m){ const n=toNum(m[0]); if(Number.isFinite(n)) return n; }
    }
    return 0;
  }

  function cf_rangeFacts(facts, desde, hasta, emp){
    let arr=(facts||[]).filter(f=>(!desde||f.fecha>=desde)&&(!hasta||f.fecha<=hasta));
    if(emp) arr=arr.filter(f=>f.emp===emp);
    return arr;
  }

  function cf_groupMetodo(ventas){
    const map={}; let total=0;
    ventas.forEach(v=>{ const m=(v.pago||'Otro').trim(); map[m]=(map[m]||0)+(+v.tot||0); total+=(+v.tot||0); });
    return {map,total};
  }

  function cf_compute(desde, hasta, emp, incluirPropinas, saldoInicial){
    const facts=load(CFK.FACTS,[])||[];
    const ventas = cf_rangeFacts(facts,desde,hasta,emp).map(f=>({
      num:f.num, fecha:f.fecha, emp:f.emp, pago:f.pago,
      sub:toNum(f.sub), tax:toNum(f.tax), tot:toNum(f.tot), prop:cf_propina(f)
    }));
    const gastos=(load(CFK.GASTOS,[])||[]).filter(g=>(!desde||g.fecha>=desde)&&(!hasta||g.fecha<=hasta));
    const movs=(load(CFK.MOVS,[])||[]).filter(m=>(!desde||m.fecha>=desde)&&(!hasta||m.fecha<=hasta));
    const ingresos=ventas.reduce((a,v)=>a+v.tot,0);
    const propinas=ventas.reduce((a,v)=>a+v.prop,0);
    const gastosSum=gastos.reduce((a,g)=>a+toNum(g.monto),0);
    const retiros=movs.filter(m=>m.tipo==='Retiro').reduce((a,m)=>a+toNum(m.monto),0);
    const depositos=movs.filter(m=>m.tipo==='Dep√≥sito').reduce((a,m)=>a+toNum(m.monto),0);
    const netoBase=ingresos+(incluirPropinas?propinas:0)-gastosSum;
    const neto=netoBase+depositos-retiros;
    const cajaFinal=toNum(saldoInicial)+neto;
    const {map:metodos,total:ingresosCheck}=cf_groupMetodo(ventas);
    return {ventas,gastos,movs,ingresos,propinas,gastosSum,retiros,depositos,netoBase,neto,cajaFinal,saldoInicial:toNum(saldoInicial),metodos,ingresosCheck};
  }

  function cf_resumenTecnicas(ventas){
    const map={};
    ventas.forEach(v=>{
      const name=cf_empName(v.emp)||'(Sin t√©cnica)';
      if(!map[name]) map[name]={ventas:0, prop:0};
      map[name].ventas += v.tot;
      map[name].prop   += v.prop;
    });
    return map;
  }

  function cf_resumenDiario(desde,hasta,emp,incluirPropinas,metodo){
    const facts=load(CFK.FACTS,[])||[];
    const gastos=load(CFK.GASTOS,[])||[];
    const d0=new Date(desde||todayISO()), d1=new Date(hasta||todayISO());
    const out=[];
    for(let d=new Date(d0); d<=d1; d.setDate(d.getDate()+1)){
      const iso=d.toISOString().slice(0,10);
      let vs=facts.filter(f=>f.fecha===iso);
      if(emp) vs=vs.filter(f=>f.emp===emp);
      if(metodo) vs=vs.filter(f=>(f.pago||'').trim()===metodo);
      const ventas=vs.reduce((a,f)=>a+toNum(f.tot),0);
      const prop=incluirPropinas?vs.reduce((a,f)=>a+cf_propina(f),0):0;
      const gs=gastos.filter(g=>g.fecha===iso).reduce((a,g)=>a+toNum(g.monto),0);
      out.push({fecha:iso, ventas, prop, gastos:gs, neto:ventas+prop-gs});
    }
    return out;
  }

  // Renders
  function cf_renderVentas(ventas){
    const tb=byId('cf_tbVentas');
    tb.innerHTML = ventas.map(v=>`
      <tr class="tr">
        <td>${v.num}</td><td>${v.fecha}</td><td>${cf_empName(v.emp)}</td><td>${v.pago||''}</td>
        <td>${fmt(v.sub)}</td><td>${fmt(v.tax)}</td><td>${fmt(v.tot)}</td><td>${fmt(v.prop)}</td>
      </tr>`).join('') || `<tr class="tr"><td colspan="8">Sin ventas</td></tr>`;
  }
  function cf_renderGastos(gastos){
    const tb=byId('cf_tbGastos');
    tb.innerHTML = gastos.map((g,i)=>`
      <tr class="tr">
        <td>${g.fecha}</td><td>${g.concepto}</td><td>${fmt(g.monto)}</td>
        <td class="no-print"><button class="btn-ghost" onclick="cf_delGasto(${i})">Borrar</button></td>
      </tr>`).join('') || `<tr class="tr"><td colspan="4">Sin gastos</td></tr>`;
  }
  function cf_renderMovs(movs){
    const tb=byId('cf_tbMovs');
    tb.innerHTML = movs.map((m,i)=>`
      <tr class="tr"><td>${m.fecha}</td><td>${m.tipo}</td><td>${fmt(m.monto)}</td>
      <td class="no-print"><button class="btn-ghost" onclick="cf_delMov(${i})">Borrar</button></td></tr>
    `).join('') || `<tr class="tr"><td colspan="4">Sin movimientos</td></tr>`;
  }
  function cf_renderMetodos(metodos,total){
    const tb=byId('cf_tbMetodos');
    if(!total){ tb.innerHTML=`<tr class="tr"><td colspan="3">Sin ventas</td></tr>`; return; }
    tb.innerHTML = Object.entries(metodos).map(([m,v])=>{
      const pct=(v/total*100).toFixed(1)+'%';
      return `<tr class="tr"><td>${m}</td><td>${fmt(v)}</td><td>${pct}</td></tr>`;
    }).join('');
  }
  function cf_renderTecnicas(map){
    const rows=Object.entries(map).sort((a,b)=>b[1].ventas-a[1].ventas)
      .map(([tec,vals])=>`<tr class="tr"><td>${tec}</td><td>${fmt(vals.ventas)}</td><td>${fmt(vals.prop)}</td></tr>`).join('');
    byId('cf_tbTecnicas').innerHTML = rows || `<tr class="tr"><td colspan="3">Sin datos</td></tr>`;
  }
  function cf_renderDiario(rows){
    byId('cf_tbDiario').innerHTML = rows.map(r=>`
      <tr class="tr"><td>${r.fecha}</td><td>${fmt(r.ventas)}</td><td>${fmt(r.prop)}</td><td>${fmt(r.gastos)}</td><td>${fmt(r.neto)}</td></tr>
    `).join('') || `<tr class="tr"><td colspan="5">Sin datos</td></tr>`;
  }

  function cf_drawChart(desde,hasta,emp,incluirPropinas){
    const cvs=byId('cf_chart'); if(!cvs) return;
    const ctx=cvs.getContext('2d');
    const W=cvs.width = cvs.clientWidth || 900, H=cvs.height;
    ctx.clearRect(0,0,W,H);

    const d0=new Date(desde||todayISO()), d1=new Date(hasta||todayISO());
    const facts=load(CFK.FACTS,[])||[], gastos=load(CFK.GASTOS,[])||[];
    const days=[];
    for(let d=new Date(d0); d<=d1; d.setDate(d.getDate()+1)) days.push(d.toISOString().slice(0,10));

    const serie=days.map(day=>{
      let vs=facts.filter(f=>f.fecha===day);
      if(emp) vs=vs.filter(f=>f.emp===emp);
      const ingresos=vs.reduce((a,f)=>a+toNum(f.tot),0) + (incluirPropinas? vs.reduce((a,f)=>a+cf_propina(f),0):0);
      const gs=gastos.filter(x=>x.fecha===day).reduce((a,b)=>a+toNum(b.monto),0);
      return {day, neto:ingresos-gs};
    });

    const pad=30; const max=Math.max(1,...serie.map(s=>s.neto));
    ctx.strokeStyle='#cdd4ff'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(pad,10); ctx.lineTo(pad,H-pad); ctx.lineTo(W-10,H-pad); ctx.stroke();
    ctx.fillStyle='#9aa3c7'; ctx.font='12px sans-serif';
    for(let i=0;i<=4;i++){
      const val=max*i/4; const y=H-pad-(H-2*pad)*(val/max);
      ctx.fillText((val).toFixed(0),4,y+4);
      ctx.strokeStyle='rgba(205,212,255,.15)'; ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-10,y); ctx.stroke();
    }
    const dx=(W-2*pad)/(Math.max(1,serie.length-1));
    ctx.beginPath();
    serie.forEach((p,idx)=>{ const x=pad+dx*idx; const y=H-pad-(H-2*pad)*((p.neto<0?0:p.neto)/max); if(idx===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
    ctx.strokeStyle='#93c5fd'; ctx.lineWidth=2; ctx.stroke();
  }

  // CRUD gastos / movimientos (expuestos global para onclick)
  window.cf_delGasto = function(i){
    const arr=load(CFK.GASTOS,[]); arr.splice(i,1); save(CFK.GASTOS,arr); cf_aplicar();
  };
  window.cf_delMov = function(i){
    const arr=load(CFK.MOVS,[]); arr.splice(i,1); save(CFK.MOVS,arr); cf_aplicar();
  };

  function cf_addGasto(){
    const concepto=byId('cf_g_concepto').value.trim();
    const fecha=byId('cf_g_fecha').value||todayISO();
    const monto=toNum(byId('cf_g_monto').value);
    if(!concepto||!monto){ alert('Concepto y monto requeridos'); return; }
    const arr=load(CFK.GASTOS,[]); arr.push({concepto,fecha,monto}); save(CFK.GASTOS,arr);
    byId('cf_g_concepto').value=''; byId('cf_g_monto').value='';
    cf_aplicar();
  }
  function cf_addMov(){
    const tipo=byId('cf_m_tipo').value;
    const fecha=byId('cf_m_fecha').value||todayISO();
    const monto=toNum(byId('cf_m_monto').value);
    if(!monto){ alert('Monto requerido'); return; }
    const arr=load(CFK.MOVS,[]); arr.push({tipo,fecha,monto}); save(CFK.MOVS,arr);
    byId('cf_m_monto').value='';
    cf_aplicar();
  }

  // Export CSV
  function cf_exportCSV(){
    const desde=byId('cf_desde').value, hasta=byId('cf_hasta').value, emp=byId('cf_emp').value;
    const ip=byId('cf_propinas').value==='1'; const saldo=toNum(byId('cf_saldo').value);
    const res=cf_compute(desde,hasta,emp,ip,saldo);

    let lines=[];
    lines.push(['Periodo',desde||'',hasta||''].map(csvSafe).join(','));
    lines.push(['Empleado', emp? cf_empName(emp): 'Todas'].map(csvSafe).join(','));
    lines.push(['Propinas incluidas', ip?'S√≠':'No'].map(csvSafe).join(','));
    lines.push(['Saldo inicial', res.saldoInicial].map(csvSafe).join(','));
    lines.push(['Retiros', res.retiros].map(csvSafe).join(','));
    lines.push(['Dep√≥sitos', res.depositos].map(csvSafe).join(','));
    lines.push([]);

    lines.push(['Ventas','#','Fecha','Empleado','M√©todo','Subtotal','IVU','Total','Propina'].map(csvSafe).join(','));
    res.ventas.forEach(v=>{
      lines.push(['',v.num,v.fecha,cf_empName(v.emp),v.pago,v.sub,v.tax,v.tot,v.prop].map(csvSafe).join(','));
    });

    lines.push([]);
    lines.push(['Gastos','Fecha','Concepto','Monto'].map(csvSafe).join(','));
    res.gastos.forEach(g=> lines.push(['',g.fecha,g.concepto,g.monto].map(csvSafe).join(',')));

    lines.push([]);
    lines.push(['Caja por m√©todo','M√©todo','Monto','% Ingresos'].map(csvSafe).join(','));
    Object.entries(res.metodos).forEach(([m,v])=>{
      const pct=res.ingresos?(v/res.ingresos*100).toFixed(1)+'%':'0%';
      lines.push(['',m,v,pct].map(csvSafe).join(','));
    });

    lines.push([]);
    lines.push(['Resumen','Ingresos',res.ingresos,'Propinas (incl)',ip?res.propinas:0,'Gastos',res.gastosSum,'Retiros',res.retiros,'Dep√≥sitos',res.depositos,'Caja Inicial',res.saldoInicial,'Flujo Neto',res.neto,'Caja Final',res.cajaFinal].map(csvSafe).join(','));

    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([lines.join('\n')],{type:'text/csv'}));
    a.download=`flujo_${desde||'inicio'}_a_${hasta||'fin'}.csv`;
    a.click(); URL.revokeObjectURL(a.href);
  }

  // PDF
  function cf_pdf(){
    const desde=byId('cf_desde').value, hasta=byId('cf_hasta').value, emp=byId('cf_emp').value;
    const ip=byId('cf_propinas').value==='1'; const saldo=toNum(byId('cf_saldo').value);
    const metodo=byId('cf_metodo').value;
    const res=cf_compute(desde,hasta,emp,ip,saldo);
    const diario=cf_resumenDiario(desde,hasta,emp,ip,metodo);
    const tec=cf_resumenTecnicas(res.ventas);

    const style=`<style>
      body{font-family:system-ui,Segoe UI,Inter,Arial; padding:22px}
      h1,h2,h3{margin:0}
      table{width:100%; border-collapse:collapse; margin-top:8px}
      th,td{border:1px solid #ddd; padding:6px; font-size:12px}
      .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
      .card{border:1px solid #ddd; border-radius:10px; padding:10px}
      .muted{color:#666}
    </style>`;

    const tbl=(h,rows)=>`<table><thead><tr>${h.map(x=>`<th>${x}</th>`).join('')}</tr></thead><tbody>${rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}</tbody></table>`;

    const kpis = `
      <div class="grid">
        <div class="card"><b>Ingresos</b><div>${fmt(res.ingresos)}</div></div>
        <div class="card"><b>Propinas ${ip?'(incl.)':''}</b><div>${fmt(ip?res.propinas:0)}</div></div>
        <div class="card"><b>Gastos</b><div>${fmt(res.gastosSum)}</div></div>
        <div class="card"><b>Retiros</b><div>${fmt(res.retiros)}</div></div>
        <div class="card"><b>Dep√≥sitos</b><div>${fmt(res.depositos)}</div></div>
        <div class="card"><b>Caja Final</b><div>${fmt(res.cajaFinal)}</div></div>
      </div>`;

    const ventasHead=['#','Fecha','T√©cnica','M√©todo','Subtotal','IVU','Total','Propina'];
    const ventasRows=res.ventas.map(v=>[v.num,v.fecha,cf_empName(v.emp),v.pago,fmt(v.sub),fmt(v.tax),fmt(v.tot),fmt(v.prop)]);

    const tecnicasHead=['T√©cnica','Ventas','Propinas'];
    const tecnicasRows=Object.entries(tec).map(([t,v])=>[t,fmt(v.ventas),fmt(v.prop)]);

    const diarioHead=['Fecha','Ventas','Propinas','Gastos','Neto'];
    const diarioRows=diario.map(r=>[r.fecha,fmt(r.ventas),fmt(r.prop),fmt(r.gastos),fmt(r.neto)]);

    const gastosHead=['Fecha','Concepto','Monto'];
    const gastosRows=res.gastos.map(g=>[g.fecha,g.concepto,fmt(g.monto)]);

    const metodosHead=['M√©todo','Monto','% Ingresos'];
    const metodosRows=Object.entries(res.metodos).map(([m,v])=>[m,fmt(v), (res.ingresos?(v/res.ingresos*100).toFixed(1):'0.0')+'%']);

    const html = `
      <html><head><meta charset="utf-8"><title>Flujo de Caja</title>${style}</head><body>
      <h2>Flujo de Caja</h2>
      <div class="muted">${desde||'inicio'} a ${hasta||'fin'} ‚Äî ${emp?cf_empName(emp):'Todas las t√©cnicas'}</div>
      ${kpis}
      ${tbl(metodosHead, metodosRows)}
      ${tbl(tecnicasHead, tecnicasRows)}
      ${tbl(diarioHead, diarioRows)}
      <h3>Ventas</h3>
      ${tbl(ventasHead, ventasRows)}
      <h3>Gastos</h3>
      ${tbl(gastosHead, gastosRows)}
      </body></html>`;
    const w=window.open('','_blank'); w.document.write(html); w.document.close(); w.focus(); w.print();
  }

  function cf_setPeriodoMes(){
    const d=new Date();
    const ini=new Date(d.getFullYear(), d.getMonth(), 1).toISOString().slice(0,10);
    const fin=new Date(d.getFullYear(), d.getMonth()+1, 0).toISOString().slice(0,10);
    byId('cf_desde').value=ini; byId('cf_hasta').value=fin;
  }
  function cf_setHoy(){
    const t=todayISO(); byId('cf_desde').value=t; byId('cf_hasta').value=t;
  }

  function cf_aplicar(){
    const desde=byId('cf_desde').value, hasta=byId('cf_hasta').value, emp=byId('cf_emp').value;
    const ip=byId('cf_propinas').value==='1'; const saldo=toNum(byId('cf_saldo').value);
    const res=cf_compute(desde,hasta,emp,ip,saldo);
    byId('cf_kpi_ingresos').textContent=fmt(res.ingresos);
    byId('cf_kpi_propinas').textContent=fmt(ip?res.propinas:0);
    byId('cf_kpi_gastos').textContent=fmt(res.gastosSum);
    byId('cf_kpi_inicial').textContent=fmt(res.saldoInicial);
    byId('cf_kpi_neto').textContent=fmt(res.neto);
    byId('cf_kpi_final').textContent=fmt(res.cajaFinal);

    cf_renderVentas(res.ventas);
    cf_renderGastos(res.gastos);
    cf_renderMovs(res.movs);

    const tec = cf_resumenTecnicas(res.ventas);
    cf_renderTecnicas(tec);

    cf_renderMetodos(res.metodos, res.ingresos);
    cf_drawChart(desde,hasta,emp,ip);

    const met=byId('cf_metodo').value;
    const diario=cf_resumenDiario(desde,hasta,emp,ip,met);
    cf_renderDiario(diario);

    // Guardar preferencias
    save(CFK.CFG,{propinas: ip?1:0, saldo: saldo});
  }

  function cf_bind(){
    // tabs dentro de facturaci√≥n
    const bFact=byId('cf_tab_facturar'), bFlujo=byId('cf_tab_flujo');
    const vFact=byId('cf_view_facturar'), vFlujo=byId('cf_view_flujo');
    if(bFact && bFlujo){
      const setTab = (name)=>{
        [bFact,bFlujo].forEach(b=>b.classList.remove('active'));
        [vFact,vFlujo].forEach(v=>v.classList.remove('active'));
        if(name==='fact'){ bFact.classList.add('active'); vFact.classList.add('active'); }
        else { bFlujo.classList.add('active'); vFlujo.classList.add('active'); }
      };
      bFact.addEventListener('click', ()=>setTab('fact'));
      bFlujo.addEventListener('click', ()=>setTab('flujo'));
    }

    byId('cf_btnHoy')?.addEventListener('click', ()=>{ cf_setHoy(); cf_aplicar(); });
    byId('cf_btnMes')?.addEventListener('click', ()=>{ cf_setPeriodoMes(); cf_aplicar(); });
    byId('cf_btnRango')?.addEventListener('click', ()=>{ /* manual */ cf_aplicar(); });

    byId('cf_btnAplicar')?.addEventListener('click', cf_aplicar);
    byId('cf_btnReset')?.addEventListener('click', ()=>{
      const cfg=load(CFK.CFG,{propinas:0, saldo:0});
      byId('cf_propinas').value = cfg.propinas?'1':'0';
      byId('cf_saldo').value = toNum(cfg.saldo);
      cf_setPeriodoMes();
      cf_aplicar();
    });

    byId('cf_btnCSV')?.addEventListener('click', cf_exportCSV);
    byId('cf_btnPDF')?.addEventListener('click', cf_pdf);
    byId('cf_btnGAdd')?.addEventListener('click', cf_addGasto);
    byId('cf_btnMAdd')?.addEventListener('click', cf_addMov);

    // Cambios que re-aplican
    ['cf_desde','cf_hasta','cf_emp','cf_propinas','cf_saldo','cf_metodo'].forEach(id=>{
      byId(id)?.addEventListener('change', cf_aplicar);
    });
  }

  function cf_init(){
    cf_ensureStores();
    cf_fillEmps(true);       // incluye "Todas"
    const cfg=load(CFK.CFG,{propinas:0, saldo:0});
    byId('cf_propinas').value = cfg.propinas ? '1':'0';
    byId('cf_saldo').value = toNum(cfg.saldo);
    cf_setPeriodoMes();
    cf_aplicar();
    cf_bind();
  }

  // Arranque cuando el DOM est√© listo (despu√©s de tu boot())
  window.addEventListener('DOMContentLoaded', cf_init);
})();
</script>
</body>
</html>

